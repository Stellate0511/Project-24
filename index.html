<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROJECT: 24</title>
    <style>
        :root {
            --bg-color: #020408;
            --win-bg: #050a14;
            --primary-color: #00f3ff;
            --secondary-color: #005f73;
            --alert-color: #ff2a6d;
            --success-color: #00ff9d;
            --text-color: #e0fbfc;
            --card-w: 65px;
            --card-h: 95px;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at center, #0a1525 0%, #000 100%);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- 主窗口 --- */
        #main-window {
            width: 95%;
            max-width: 800px;
            height: 90vh; 
            max-height: 750px;
            min-height: 500px; 
            background: var(--win-bg);
            border: 1px solid var(--secondary-color);
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.08);
            position: relative;
            display: flex;
            flex-direction: column; /* 垂直排列：内容 + 页脚 */
        }

        /* 装饰角标 */
        #main-window::before {
            content: ''; position: absolute; top: 0; left: 0; width: 20px; height: 20px;
            border-top: 2px solid var(--primary-color); border-left: 2px solid var(--primary-color); z-index: 10;
        }
        #main-window::after {
            content: ''; position: absolute; bottom: 0; right: 0; width: 20px; height: 20px;
            border-bottom: 2px solid var(--primary-color); border-right: 2px solid var(--primary-color); z-index: 10;
        }

        button {
            background: rgba(0, 95, 115, 0.15);
            border: 1px solid var(--secondary-color);
            color: var(--text-color);
            padding: 10px 20px;
            cursor: pointer;
            font-family: inherit;
            text-transform: uppercase;
            font-weight: bold;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        button:hover:not(:disabled) {
            background: var(--primary-color); color: var(--bg-color); box-shadow: 0 0 10px var(--primary-color);
        }
        button:disabled {
            opacity: 0.3; cursor: not-allowed; border-color: #333; color: #666; background: transparent;
        }
        button.active {
            background: var(--primary-color); color: var(--bg-color);
        }

        /* --- 启动菜单 (改为 Flex Item) --- */
        #start-screen {
            /* 移除 absolute，改为占据剩余空间 */
            flex: 1;
            width: 100%;
            background: rgba(5, 10, 20, 0.98);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100;
        }
        h1 {
            font-size: 2.2rem; color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-color);
            margin-bottom: 2rem; letter-spacing: 4px; border-bottom: 2px solid;
            text-align: center;
        }
        .config-group { margin-bottom: 20px; text-align: center; width: 85%; }
        .config-title { color: var(--secondary-color); font-size: 0.7rem; margin-bottom: 8px; display: block; }
        .btn-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .btn-group button { flex: 1; padding: 10px 0; font-size: 0.8rem; min-width: 80px; }
        #start-btn { margin-top: 30px; font-size: 1.1rem; padding: 12px 50px; border-color: var(--primary-color); }

        /* --- 游戏主界面 (改为 Flex Item) --- */
        #game-ui { 
            display: none; 
            flex-direction: column; 
            width: 100%; 
            flex: 1; /* 关键：占据除 footer 外的所有空间 */
            min-height: 0; /* 防止内容溢出撑破 flex 容器 */
        }

        /* 顶部状态栏 */
        .top-bar {
            min-height: 50px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 20px;
            background: rgba(0, 243, 255, 0.03);
            border-bottom: 1px solid rgba(0, 243, 255, 0.1);
            flex-shrink: 0;
            flex-wrap: wrap; gap: 10px;
        }
        .stat-group { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .stat-item { display: flex; flex-direction: row; gap: 8px; align-items: baseline; }
        .stat-label { font-size: 0.7rem; color: var(--secondary-color); }
        .stat-val { font-size: 1rem; font-weight: bold; min-width: 25px; }
        .menu-btns { display: flex; gap: 10px; }
        .menu-btns button { padding: 5px 12px; font-size: 0.7rem; height: 30px; }

        @media (max-width: 600px) {
            .top-bar { justify-content: center; padding: 10px; }
            .stat-group { width: 100%; justify-content: space-around; border-bottom: 1px dashed rgba(0, 243, 255, 0.1); padding-bottom: 8px; margin-bottom: 2px; }
            .menu-btns { width: 100%; justify-content: center; }
            .stat-group { gap: 10px; }
            h1 { font-size: 1.8rem; }
        }

        /* 进度条 */
        .progress-area {
            height: 4px; width: 100%; background: #111; position: relative; flex-shrink: 0;
        }
        #timer-bar { height: 100%; background: var(--primary-color); width: 0%; transition: width 0.1s linear; }

        /* 卡牌区 */
        #card-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            align-content: center;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px;
            overflow-y: auto;
            position: relative;
            touch-action: none; /* 关键：禁止浏览器处理该区域的滑动手势 */
            user-select: none;
        }

        body, button, .card {
            touch-action: manipulation; /* 允许点击和滚动，但禁用双击缩放 */
        }

        #btn-all {
            display: none; /* 默认隐藏 */
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: rgba(0, 243, 255, 0.1);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
            margin-right: 10px; /* 与其他按钮拉开距离 */
        }
        #btn-all:hover {
            background: var(--primary-color);
            color: #000;
        }

        /* 卡牌 */
        .card {
            width: var(--card-w); height: var(--card-h);
            border: 1px solid var(--secondary-color);
            background: rgba(8, 20, 30, 0.6); 
            color: var(--secondary-color);
            display: flex; justify-content: center; align-items: center;
            font-size: 1.8rem; font-weight: bold;
            cursor: pointer; position: relative; 
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            clip-path: polygon(6px 0, 100% 0, 100% calc(100% - 6px), calc(100% - 6px) 100%, 0 100%, 0 6px);
            user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent;
            
            touch-action: none;
        }
        .card:hover { background: rgba(0, 243, 255, 0.1); border-color: var(--primary-color); color: var(--primary-color); }
        .card.selected {
            transform: translateY(-12px); border-color: #fff; color: #fff;
            background: rgba(0, 243, 255, 0.25); box-shadow: 0 0 15px var(--primary-color); z-index: 5;
        }

        /* --- 新增：卡牌入场动画 --- */
        .card.anim-enter {
            animation: card-entry 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            /* 初始状态：不可见，防止闪烁 */
            opacity: 0; 
        }

        @keyframes card-entry {
            0% {
                opacity: 0;
                transform: translateY(-60px) scale(1.1); /* 从上方60px处落下，稍微放大 */
                background-color: var(--primary-color);  /* 高亮：完全变成青色 */
                color: #000;
                box-shadow: 0 0 30px var(--primary-color); /* 强光晕 */
                border-color: var(--primary-color);
            }
            50% {
                opacity: 1;
                /* 变回正常颜色，但保持一点光晕 */
                background-color: rgba(0, 243, 255, 0.3); 
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1); /* 归位 */
                /* 属性复原交给 .card 默认样式，这里不需要强制写死颜色，只需 transform 归位 */
            }
        }

        /* 底部控制栏 */
        .bottom-bar {
            min-height: 70px; height: auto;
            display: flex; align-items: center; justify-content: flex-end;
            gap: 15px; padding: 10px 20px;
            border-top: 1px solid rgba(0, 243, 255, 0.1);
            background: rgba(0,0,0,0.2);
            flex-shrink: 0;
            flex-wrap: wrap;
        }
        #msg-display {
            margin-right: auto; color: var(--secondary-color); font-size: 0.8rem; letter-spacing: 2px;
            width: 100%; text-align: center; margin-bottom: 5px;
        }
        @media (min-width: 601px) { #msg-display { width: auto; margin-bottom: 0; text-align: left; } }
        
        #btn-exec { min-width: 100px; }
        #btn-exec.ready {
            background: var(--primary-color); color: #000; box-shadow: 0 0 20px var(--primary-color); animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 50% { opacity: 0.7; box-shadow: 0 0 5px var(--primary-color); } }

        /* --- 新增：底部安全区 / Footer --- */
        .footer-bar {
            height: 40px; /* 固定高度作为缓冲 */
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            border-top: 1px solid rgba(0, 243, 255, 0.05);
            background: rgba(0, 0, 0, 0.4);
            
            color: var(--secondary-color);
            font-size: 0.6rem;
            letter-spacing: 2px;
            text-shadow: 0 0 5px rgba(0, 243, 255, 0.2);
            animation: text-breathe 4s infinite ease-in-out;
        }

        @keyframes text-breathe {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.8; text-shadow: 0 0 8px var(--primary-color); }
        }

        /* --- 弹窗 --- */
        #game-over, #review-ui {
            display: none; position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(2, 4, 8, 0.98); z-index: 999;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .title-success { font-size: 3rem; color: var(--success-color); text-shadow: 0 0 20px var(--success-color); margin-bottom: 10px; text-align: center; }
        .title-failure { font-size: 3rem; color: var(--alert-color); text-shadow: 0 0 20px var(--alert-color), 0 0 10px var(--alert-color); margin-bottom: 10px; text-align: center; }
        .end-stat { font-size: 1rem; color: var(--text-color); margin-bottom: 5px; }

        /* 复盘 */
        #review-ui { align-items: stretch; flex-direction: row; background: #000; }
        #review-list { width: 180px; border-right: 1px solid #333; overflow-y: auto; background: rgba(0, 243, 255, 0.02); }
        .log-entry { padding: 15px; border-bottom: 1px solid #222; font-size: 0.75rem; color: #666; cursor: pointer; text-align: right; }
        .log-entry:hover, .log-entry.active { background: #111; color: var(--primary-color); border-right: 3px solid var(--primary-color); }
        #review-detail { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #review-display { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; justify-content: center; }

    </style>
</head>
<body>

    <div id="main-window">
        
        <!-- 启动菜单 -->
        <div id="start-screen">
            <h1>PROJECT: 24</h1>
            
            <div class="config-group">
                <span class="config-title">DATASET (牌库)</span>
                <div class="btn-group" id="opt-deck">
                    <button class="active" data-val="standard">标准</button>
                    <button data-val="hard">困难</button>
                    <button data-val="hell" style="color:var(--alert-color)">地狱</button>
                </div>
            </div>

            <div class="config-group">
                <span class="config-title">TIMER (计时)</span>
                <div class="btn-group" id="opt-time">
                    <button class="active" data-val="endless">无尽</button>
                    <button data-val="hourglass">沙漏</button>
                    <button data-val="breathing">呼吸</button>
                </div>
            </div>

            <div class="config-group">
                <span class="config-title">TOLERANCE (机会)</span>
                <div class="btn-group" id="opt-life">
                    <button data-val="casual">休闲 (3)</button>
                    <button class="active" data-val="challenge">挑战 (1)</button>
                    <button data-val="extreme">极限 (0)</button>
                </div>
            </div>

            <button id="start-btn">INITIATE</button>
        </div>

        <!-- 游戏界面 -->
        <div id="game-ui">
            <div class="top-bar">
                <div class="stat-group">
                    <div class="stat-item">
                        <span class="stat-label">DECK:</span>
                        <span class="stat-val" id="deck-val">--</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">TIME:</span>
                        <span class="stat-val" id="time-val">00:00</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">CHANCES:</span>
                        <span class="stat-val" id="chance-val" style="color:var(--alert-color)">--</span>
                    </div>
                </div>
                <div class="menu-btns">
                    <button onclick="startGame()">RESTART</button>
                    <button onclick="backToMenu()">MENU</button>
                </div>
            </div>

            <div class="progress-area">
                <div id="timer-bar"></div>
            </div>

            <div id="card-container">
                <!-- Cards Here -->
            </div>

            <div class="bottom-bar">
                <div id="msg-display">SYSTEM READY</div>
                <button id="btn-all" onclick="selectAllAndExec()">ALL IN</button>
                <button id="btn-draw">DRAW</button>
                <button id="btn-exec" disabled>EXECUTE</button>
            </div>
        </div>

        <!-- Footnote / Safe Area Spacer -->
        <div class="footer-bar">
            BUILD: 2025 // CREATOR: 点缀星空
        </div>

        <!-- 结算界面 (胜负通用) -->
        <div id="game-over">
            <div id="end-title" class="title-failure">FAILURE</div>
            <div id="end-msg" style="margin-bottom:20px; letter-spacing:1px; color:#888">SIGNAL LOST</div>
            <div id="end-time" class="end-stat" style="margin-bottom: 30px; font-weight: bold; color: var(--primary-color)">FINAL TIME: 00:00</div>
            
            <div style="display:flex; gap:15px; flex-wrap: wrap; justify-content: center;">
                <button onclick="openReview()">REVIEW</button>
                <button onclick="startGame()">RETRY</button>
                <button onclick="backToMenu()">MENU</button>
            </div>
        </div>

        <!-- 复盘 -->
        <div id="review-ui">
            <div id="review-list"></div>
            <div id="review-detail">
                <div id="review-display"></div>
                <div style="color:#555; font-size:0.7rem; margin-bottom:15px;">SOLUTION DATA</div>
                <div id="review-sol" style="font-size:1.1rem; color:var(--primary-color)">[DATA PENDING]</div>
                <button onclick="$('review-ui').style.display='none'" style="margin-top:30px; border-color:var(--alert-color)">CLOSE</button>
            </div>
        </div>

    </div>

    <script>
        const cfg = { deck:'standard', time:'endless', life:'challenge' };
        const state = {
            deck: [],
            hand: [],
            selection: [],
            history: [],
            chances: 0, 
            timer: 0,
            interval: null,
            breath: 10.0,
            active: false,
            totalTime: 0
        };

        const solutionDB = new Map();
        let isDbReady = false;
        const $ = (id) => document.getElementById(id);
        
        // --- Setup ---
        document.querySelectorAll('.btn-group button').forEach(b => {
            b.onclick = (e) => {
                const p = e.target.parentElement;
                p.querySelectorAll('button').forEach(x => x.classList.remove('active'));
                e.target.classList.add('active');
                if(p.id==='opt-deck') cfg.deck = e.target.dataset.val;
                if(p.id==='opt-time') cfg.time = e.target.dataset.val;
                if(p.id==='opt-life') cfg.life = e.target.dataset.val;
            }
        });

        $('start-btn').onclick = startGame;
        $('btn-draw').onclick = () => { drawCards(1); };
        $('btn-exec').onclick = execCards;

// --- 新增：标准的 Fisher-Yates 洗牌算法 ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                // 生成一个 0 到 i 之间的随机整数
                const j = Math.floor(Math.random() * (i + 1));
                // 交换位置
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function startGame() {
            $('start-screen').style.display = 'none';
            $('game-over').style.display = 'none';
            $('review-ui').style.display = 'none';
            $('game-ui').style.display = 'flex';

            state.history = [];
            state.hand = [];
            state.selection = [];
            state.active = true;
            state.totalTime = 0;

            // 1. Deck Init
            let pool = [];
            for(let i=1; i<=13; i++) pool.push(i,i,i,i);
            pool.push(14,15); 

            state.deck = pool.filter(n => {
                if(cfg.deck === 'hard') return n!==3 && n!==6;
                if(cfg.deck === 'hell') return ![2,3,4,6,8,12].includes(n);
                return true;
            });
            shuffleArray(state.deck);

            // 2. Chances
            if(cfg.life === 'casual') state.chances = 3;
            else if(cfg.life === 'challenge') state.chances = 1;
            else state.chances = 0;
            updateStats();

            // 3. Timer
            clearInterval(state.interval);
            if(cfg.time === 'hourglass') state.timer = 60.0; // 改为浮点数
            else if(cfg.time === 'breathing') state.breath = 10.0;
            else state.timer = 0;

            state.interval = setInterval(tick, 100);

            // 4. Draw
            drawCards(10);
            setStatus("SYSTEM READY", "var(--secondary-color)");
        }

        function tick() {
            if(!state.active) return;

            // 所有模式都累加总游戏时长
            state.totalTime += 0.1;

            if(cfg.time === 'endless') {
                state.timer += 0.1;
                $('time-val').innerText = fmtTime(state.timer); // 无限模式保持 mm:ss
            }
            else if(cfg.time === 'hourglass') {
                state.timer -= 0.1;
                
                // --- 修改点：沙漏模式现在显示为 "59.9" 格式 ---
                // 避免出现负数显示
                let displayTime = Math.max(0, state.timer);
                $('time-val').innerText = displayTime.toFixed(1);
                
                let pct = (state.timer / 60) * 100;
                $('timer-bar').style.width = pct + "%";
                if(state.timer <= 0) gameOver("TIME EXHAUSTED", false);
            }
            else if(cfg.time === 'breathing') {
                state.breath -= 0.1;
                let pct = (state.breath / 10.0) * 100;
                $('timer-bar').style.width = pct + "%";
                $('time-val').innerText = state.breath.toFixed(1); // 呼吸模式保持秒数格式
                
                if(state.breath <= 3) $('timer-bar').style.backgroundColor = 'var(--alert-color)';
                else $('timer-bar').style.backgroundColor = 'var(--primary-color)';

                if(state.breath <= 0) {
                    fail("TIMEOUT");
                    state.breath = 10.0;
                }
            }
        }

        function fmtTime(s) {
            let m = Math.floor(s/60);
            let sec = Math.floor(s%60);
            return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        }

        function drawCards(n) {
            if(state.hand.length >= 10) return;

            for(let i=0; i<n; i++) {
                if(state.deck.length === 0) break;
                if(state.hand.length >= 10) break;
                
                let val = state.deck.pop();
                // 标记为新牌
                state.hand.push({ id: Math.random(), val: val, isNew: true });
            }
            
            sortHand();
            render(); // 第一次渲染：带动画类
            updateDrawBtn();

            // --- 关键修改 ---
            // 渲染之后，立刻把数据里的 isNew 标记去掉。
            // 这样 DOM 上的动画会继续播放，但如果你点击屏幕触发下一次 render()，
            // 生成的新 DOM 就不会再有 anim-enter 类，动画就不会重播了 (会直接跳到选中/非选中状态)
            state.hand.forEach(c => c.isNew = false);
        }

        function sortHand() {
            state.hand.sort((a,b) => a.val - b.val);
        }

        // 辅助：仅切换视觉状态，不重绘整个 DOM
        function updateCardVisual(id) {
            // 找到对应的 DOM 元素
            const cardDiv = document.querySelector(`.card[data-id="${id}"]`);
            if (!cardDiv) return;

            const isSelected = state.selection.includes(id);
            
            if (isSelected) {
                cardDiv.classList.add('selected');
            } else {
                cardDiv.classList.remove('selected');
            }

            // 更新按钮状态 (Execute 按钮可用性)
            let sc = state.selection.length;
            let btn = $('btn-exec');
            if(sc >= 2 && sc <= 4) {
                btn.disabled = false;
                btn.classList.add('ready');
                btn.innerText = "EXECUTE";
            } else {
                btn.disabled = true;
                btn.classList.remove('ready');
                btn.innerText = sc < 2 ? "SELECT (2-4)" : "FULL";
            }
        }

        function setCardSelection(id, shouldSelect) {
            const idx = state.selection.indexOf(id);
            
            if (shouldSelect) {
                // 选中逻辑：限制最多 4 张
                if (idx === -1 && state.selection.length < 4) {
                    state.selection.push(id);
                    // --- 修改点：不再调用 render()，而是只更新样式 ---
                    updateCardVisual(id);
                }
            } else {
                // 取消逻辑
                if (idx > -1) {
                    state.selection.splice(idx, 1);
                    // --- 修改点：不再调用 render()，而是只更新样式 ---
                    updateCardVisual(id);
                }
            }
        }

        // --- 同时也需要修改一下 toggleSelect 给鼠标点击用 ---
        // 鼠标点击也应该走这个“轻量级”更新，而不是重绘
        function toggleSelect(id) {
            const idx = state.selection.indexOf(id);
            // 判断当前意图：如果已选中则取消，未选中则选中
            const targetState = (idx === -1);
            setCardSelection(id, targetState);
        }
        function render() {
            const container = $('card-container');
            container.innerHTML = '';
            
            let newCardIndex = 0; 

            state.hand.forEach(c => {
                let div = document.createElement('div');
                div.innerText = c.val;
                
                // --- 修改点1：绑定 data-id 供滑动逻辑识别 ---
                div.dataset.id = c.id; 

                // 保持点击事件 (兼容鼠标操作)
                div.onclick = () => toggleSelect(c.id);
                
                let cls = 'card';
                if (state.selection.includes(c.id)) cls += ' selected';
                
                if (c.isNew) {
                    cls += ' anim-enter';
                    div.style.animationDelay = `${newCardIndex * 0.05}s`;
                    newCardIndex++;
                }

                div.className = cls;
                container.appendChild(div);
            });

            // Stats
            $('deck-val').innerText = state.deck.length;
            
            let sc = state.selection.length;
            let btn = $('btn-exec');
            if(sc >= 2 && sc <= 4) {
                btn.disabled = false;
                btn.classList.add('ready');
                btn.innerText = "EXECUTE";
            } else {
                btn.disabled = true;
                btn.classList.remove('ready');
                btn.innerText = sc < 2 ? "SELECT (2-4)" : "FULL";
            }

            // --- 修改点2：ALL IN 按钮显示逻辑 ---
            const btnAll = $('btn-all');
            // 如果手牌数量在 2 到 4 之间，显示按钮
            if (state.hand.length >= 2 && state.hand.length <= 4) {
                btnAll.style.display = 'block';
            } else {
                btnAll.style.display = 'none';
            }

            updateDrawBtn();
        }

        function updateDrawBtn() {
            let btn = $('btn-draw');
            if(state.hand.length >= 10) {
                btn.disabled = true;
                btn.innerText = "MAX";
            } else {
                btn.disabled = false;
                btn.innerText = "DRAW";
            }
            if(state.deck.length === 0) {
                 btn.disabled = true;
                 btn.innerText = "EMPTY";
            }
        }

        function setStatus(msg, color) {
            const el = $('msg-display');
            el.innerText = msg;
            el.style.color = color;
        }

        // --- Execution ---

        function execCards() {
            if(state.selection.length < 2) return;
            if(!isDbReady) {
                setStatus("DB NOT READY", "var(--alert-color)");
                return;
            }

            // 1. 获取玩家选中的牌
            let selectedCards = state.hand.filter(c => state.selection.includes(c.id));
            let values = selectedCards.map(c => c.val);

            // 2. 生成 Key
            values.sort((a, b) => a - b);
            const key = values.join(',');

            // 3. 查表
            const resultLine = solutionDB.get(key);
            
            // 4. 处理逻辑
            if(resultLine) {
                // --- 成功 ---
                setStatus("CALCULATION VALID", "var(--success-color)");
                if(cfg.time === 'breathing') state.breath = 10.0;
                
                // 记录成功解法
                state.history.push({ 
                    cards: selectedCards.map(c=>c.val), 
                    sol: resultLine,
                    status: 'success' // 标记状态
                });
            } else {
                // --- 失败 (查不到或无解) ---
                fail("INVALID / NO SOLUTION"); // 扣血
                
                // 记录失败，解法标记为 null
                state.history.push({ 
                    cards: selectedCards.map(c=>c.val), 
                    sol: null, 
                    status: 'fail' // 标记状态
                });
            }

            // 5. 公共操作：移除手牌 (无论成功失败，牌都打出去了)
            state.hand = state.hand.filter(c => !state.selection.includes(c.id));
            state.selection = [];
            render(); // 更新界面

            // 6. 胜利判定
            // 如果 fail() 导致游戏结束，state.active 会变成 false
            // 所以只有在游戏依然 active 且手牌为空时，才算赢
            if(state.active && state.hand.length === 0) {
                setTimeout(() => gameOver("MISSION COMPLETE", true), 100);
            } else if (state.active && state.hand.length > 0) {
                // 如果游戏还在继续，恢复 READY 状态
                setTimeout(() => {
                    setStatus("READY", "var(--secondary-color)");
                }, 800);
            }
        }

        function fail(reason) {
            state.chances--;
            updateStats();
            
            $('main-window').style.transform = "translateX(5px)";
            setTimeout(()=>$('main-window').style.transform="none", 50);

            if(state.chances < 0) {
                gameOver(reason, false);
            }
        }

        function updateStats() {
            let disp = state.chances < 0 ? 0 : state.chances;
            $('chance-val').innerText = disp;
        }

        function gameOver(msg, win) {
            state.active = false;
            clearInterval(state.interval);
            
            const go = $('game-over');
            go.style.display = 'flex';
            
            const title = $('end-title');
            title.innerText = win ? "SUCCESS" : "FAILURE";
            // 使用修正后的 title-failure
            title.className = win ? "title-success" : "title-failure";
            
            $('end-msg').innerText = msg;
            
            const timeEl = $('end-time');
            
            timeEl.innerText = "TOTAL TIME: " + fmtTime(state.totalTime);
        }

        function backToMenu() {
            $('game-ui').style.display = 'none';
            $('game-over').style.display = 'none';
            $('start-screen').style.display = 'flex';
            state.active = false;
            clearInterval(state.interval);
        }

        function openReview() {
            $('review-ui').style.display = 'flex';
            
            let list = $('review-list');
            let cardDisplay = $('review-display');
            let solDisplay = $('review-sol');

            // 1. 重置/清空界面 (防止显示上一局的残留)
            list.innerHTML = '';
            cardDisplay.innerHTML = '';
            solDisplay.innerText = ''; 
            
            // 如果历史记录为空
            if (state.history.length === 0) {
                solDisplay.innerText = "NO RECORDS";
                solDisplay.style.color = "var(--secondary-color)";
                return;
            }

            // 2. 生成列表
            state.history.forEach((h, i) => {
                let d = document.createElement('div');
                d.className = 'log-entry';
                if(h.status === 'fail') d.style.color = 'var(--alert-color)';
                
                d.innerText = `[${i+1}]  ${h.cards.join(' ')}`;
                
                // 点击事件
                d.onclick = function() {
                    // UI 高亮当前选中的行
                    Array.from(list.children).forEach(child => child.classList.remove('active'));
                    d.classList.add('active'); // CSS里已经写了 .active 的样式

                    // 显示卡牌
                    cardDisplay.innerHTML = h.cards.map(v => 
                        `<div class="card selected" style="cursor:default">${v}</div>`
                    ).join('');
                    
                    // 显示解法
                    if (h.sol) {
                        solDisplay.innerText = h.sol;
                        solDisplay.style.color = "var(--primary-color)";
                    } else {
                        solDisplay.innerText = "NO SOLUTION / INVALID";
                        solDisplay.style.color = "var(--alert-color)";
                    }
                };
                
                list.appendChild(d);
            });

            // 3. 自动选中第一项 (如果有)
            if (list.firstChild) {
                list.firstChild.click();
            }
        }

        // --- 滑动选择逻辑 ---
        let isSwiping = false;
        let swipeTargetState = true; 
        let touchedCardsInGesture = new Set(); 

        const container = $('card-container');

        // 触摸开始
        container.addEventListener('touchstart', (e) => {
            // 必须阻止默认行为，否则从卡牌开始滑动时，Android/iOS 可能会劫持事件流
            if(e.cancelable) e.preventDefault();
            
            isSwiping = true;
            touchedCardsInGesture.clear();
            
            // 立即处理起始点
            handleSwipe(e, true); // true 表示这是起始动作
        }, { passive: false });

        // 触摸移动
        container.addEventListener('touchmove', (e) => {
            if (!isSwiping) return;
            if(e.cancelable) e.preventDefault();
            handleSwipe(e, false);
        }, { passive: false });

        // 触摸结束
        container.addEventListener('touchend', () => {
            isSwiping = false;
            touchedCardsInGesture.clear();
        });

        // 触摸取消
        container.addEventListener('touchcancel', () => {
            isSwiping = false;
            touchedCardsInGesture.clear();
        });

        function handleSwipe(e, isStart) {
            const touch = e.touches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            
            if (!target) return;

            const cardDiv = target.closest('.card');
            
            if (cardDiv) {
                const cardId = parseFloat(cardDiv.dataset.id);
                if (isNaN(cardId)) return;

                // 核心逻辑：如果是本次手势碰到的 第一张牌
                // 我们通过它来确定“这次滑动是想全选，还是全取消”
                // 无论这张牌是在 touchstart 碰到的，还是滑动了一段距离后碰到的第一张牌
                if (touchedCardsInGesture.size === 0) {
                    const isSelected = state.selection.includes(cardId);
                    swipeTargetState = !isSelected; // 意图取反
                }

                // 如果这张牌还没被处理过，执行操作
                if (!touchedCardsInGesture.has(cardId)) {
                    touchedCardsInGesture.add(cardId);
                    setCardSelection(cardId, swipeTargetState);
                }
            }
        }

        // 辅助：指定设置某张牌的选中状态
        function setCardSelection(id, select) {
            const idx = state.selection.indexOf(id);
            if (select) {
                // 选中逻辑：限制最多 4 张
                if (idx === -1 && state.selection.length < 4) {
                    state.selection.push(id);
                    render(); // 刷新视图
                }
            } else {
                // 取消逻辑
                if (idx > -1) {
                    state.selection.splice(idx, 1);
                    render(); // 刷新视图
                }
            }
        }

        // --- 新增功能：ALL IN 逻辑 ---
        function selectAllAndExec() {
            // 选中所有手牌
            state.selection = state.hand.map(c => c.id);
            render();
            // 稍微延迟一下，让玩家看到全选的视觉反馈，再执行
            setTimeout(() => {
                execCards();
            }, 150);
        }
        
        // --- 读取并解析 database.txt (优化版) ---
        async function loadData() {
            try {
                setStatus("LOADING DATA...", "var(--primary-color)");
                
                const response = await fetch('database.txt');
                if (!response.ok) throw new Error("File not found");
                
                const text = await response.text();
                const lines = text.split('\n');

                solutionDB.clear(); // 清空旧数据

                lines.forEach(line => {
                    line = line.trim();
                    // --- 修改点：如果没有等号，直接跳过 (不存入Map) ---
                    if (!line || !line.includes('=')) return; 

                    // 解析步骤：
                    // 1. 替换非数字字符为空格，提取所有数字
                    // 2. 既然包含 '=', 最后一个数字肯定是结果(24)，弹出不要
                    let nums = line.replace(/[^\d]/g, ' ').trim().split(/\s+/).map(Number);
                    nums.pop(); 

                    // 3. 排序并生成 Key
                    nums.sort((a, b) => a - b);
                    const key = nums.join(',');

                    // 4. 存入 Map (此时 Map 里全是能赢的解法)
                    solutionDB.set(key, line);
                });

                isDbReady = true;
                setStatus("SYSTEM READY", "var(--secondary-color)");
                console.log(`Database loaded: ${solutionDB.size} solvable entries.`);

            } catch (err) {
                console.error(err);
                setStatus("DB LOAD FAIL", "var(--alert-color)");
                alert("无法读取数据库！");
            }
        }
        loadData();

    </script>
</body>
</html>
