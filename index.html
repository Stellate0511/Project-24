<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROJECT: 24</title>
    <style>
        /* === 1. å…¨å±€å˜é‡å®šä¹‰ === */
        :root {
            /* --- é»˜è®¤ä¸»é¢˜ (Dark / Cyber) --- */
            --bg-color: #020408;
            --win-bg: #050a14;
            --primary-color: #00f3ff;
            --secondary-color: #005f73;
            --alert-color: #ff2a6d;
            --success-color: #00ff9d;
            --text-color: #e0fbfc;
            --card-w: 65px;
            --card-h: 95px;
            
            /* å­—ä½“ä¸é£æ ¼å˜é‡ */
            --font-main: 'Courier New', Courier, monospace;
            --radius-main: 0px; 
            --shadow-glow: 0 0 50px rgba(0, 243, 255, 0.08);
            --btn-bg: rgba(0, 95, 115, 0.15);
            --card-bg: rgba(8, 20, 30, 0.6);
            --text-glow: 0 0 10px; /* æ§åˆ¶æ–‡å­—å‘å…‰å¼€å…³ */
            --deco-display: block; /* æ§åˆ¶èµ›åšè§’æ ‡æ˜¾ç¤º */
        }

        /* === 2. äº®è‰²/å¯çˆ±ä¸»é¢˜ (Light / Cute) === */
        html[data-theme="light"] {
            /* èƒŒæ™¯ï¼šæš–ç±³ç™½ */
            --bg-color: #f9f7f2; 
            --win-bg: #ffffff;
            
            /* é…è‰²ï¼šæ¨±èŠ±ç²‰ã€å¤©ç©ºè“ã€è–„è·ç»¿ */
            --primary-color: #ff8fab; 
            --secondary-color: #8d99ae;
            --alert-color: #ff6b6b;
            --success-color: #4ecdc4;
            --text-color: #555b6e;
            
            /* é£æ ¼ï¼šåœ†æ¶¦ã€æ— è¡¬çº¿ã€å®å¿ƒæŠ•å½± */
            --font-main: "Nunito", "Quicksand", system-ui, sans-serif;
            --radius-main: 20px;
            --shadow-glow: 0 10px 30px rgba(0,0,0,0.08);
            --btn-bg: #f0f0f0;
            --card-bg: #ffffff;
            --text-glow: 0 0 0; /* å…³é—­å‘å…‰ */
            --deco-display: none; /* éšè—è§’æ ‡ */
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            background-color: var(--bg-color);
            /* é»˜è®¤æš—è‰²æ¸å˜ï¼Œäº®è‰²æ¨¡å¼ä¼šè¢«ä¸‹é¢çš„ override è¦†ç›– */
            background-image: radial-gradient(circle at center, #0a1525 0%, #000 100%);
            color: var(--text-color);
            font-family: var(--font-main);
            min-height: 100vh;
            min-height: 100dvh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            transition: background-color 0.5s, color 0.3s; /* ä¸»é¢˜åˆ‡æ¢åŠ¨ç”» */
        }
        
        /* äº®è‰²æ¨¡å¼ç§»é™¤èƒŒæ™¯æ¸å˜ */
        html[data-theme="light"] body {
            background-image: none;
        }

        /* --- ä¸»çª—å£ --- */
        #main-window {
            width: 95%; max-width: 800px;
            height: 90vh; height: 90dvh;
            max-height: 750px; min-height: 0;
            background: var(--win-bg);
            border: 1px solid var(--secondary-color);
            box-shadow: var(--shadow-glow);
            position: relative;
            display: flex; flex-direction: column;
            
            /* ä¸»é¢˜å˜é‡æ§åˆ¶åœ†è§’ */
            border-radius: var(--radius-main);
            transition: all 0.5s;
        }
        
        /* äº®è‰²æ¨¡å¼ä¿®æ­£ä¸»çª—å£è¾¹æ¡† */
        html[data-theme="light"] #main-window {
            border: 1px solid #eee;
        }

        /* èµ›åšè§’æ ‡è£…é¥° (é€šè¿‡å˜é‡æ§åˆ¶æ˜¾éš) */
        #main-window::before {
            content: ''; position: absolute; top: 0; left: 0; width: 20px; height: 20px;
            border-top: 2px solid var(--primary-color); border-left: 2px solid var(--primary-color); z-index: 10;
            display: var(--deco-display);
        }
        #main-window::after {
            content: ''; position: absolute; bottom: 0; right: 0; width: 20px; height: 20px;
            border-bottom: 2px solid var(--primary-color); border-right: 2px solid var(--primary-color); z-index: 10;
            display: var(--deco-display);
        }

        button {
            background: var(--btn-bg);
            border: 1px solid var(--secondary-color);
            color: var(--text-color);
            padding: 10px 20px;
            cursor: pointer;
            font-family: inherit;
            text-transform: uppercase;
            font-weight: bold;
            font-size: 0.85rem;
            transition: all 0.3s;
            touch-action: manipulation;
            border-radius: var(--radius-main); /* è·Ÿéšä¸»é¢˜å˜åœ† */
        }
        
        html[data-theme="light"] button {
             border-color: transparent; /* äº®è‰²æ¨¡å¼é»˜è®¤æ— è¾¹æ¡† */
             color: #888;
        }

        button:hover:not(:disabled) {
            background: var(--primary-color); 
            color: var(--bg-color); /* äº®è‰²æ¨¡å¼ä¸‹æ–‡å­—å˜æ·±ï¼Œæš—è‰²æ¨¡å¼ä¸‹èƒŒæ™¯å˜é»‘ï¼Œé€šç”¨ */
            box-shadow: 0 0 15px var(--primary-color);
        }
        
        /* äº®è‰²æ¨¡å¼ Hover ä¿®æ­£ï¼šç™½è‰²æ–‡å­— */
        html[data-theme="light"] button:hover:not(:disabled) {
            color: #fff;
            box-shadow: 0 5px 15px rgba(255, 143, 171, 0.6); /* æŸ”å’Œç²‰è‰²é˜´å½± */
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.3; cursor: not-allowed; border-color: #333; color: #666; background: transparent;
        }
        button.active {
            background: var(--primary-color); color: var(--bg-color);
        }
        html[data-theme="light"] button.active {
            color: #fff;
            box-shadow: 0 4px 10px rgba(255, 143, 171, 0.4);
        }

        /* --- å¯åŠ¨èœå• --- */
        #start-screen {
            flex: 1; width: 100%;
            background: var(--win-bg); /* è·Ÿéšä¸»é¢˜ */
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100;
            border-radius: var(--radius-main);
        }
        
        /* äº®è‰²æ¨¡å¼å¯åŠ¨å±ç¨å¾®é€æ˜ä¸€ç‚¹ */
        html[data-theme="dark"] #start-screen { background: rgba(5, 10, 20, 0.98); }

        h1 {
            font-size: 2.2rem; color: var(--primary-color);
            text-shadow: var(--text-glow) var(--primary-color);
            margin-bottom: 2rem; letter-spacing: 4px; border-bottom: 2px solid;
            text-align: center;
            background: transparent;
        }
        /* äº®è‰²æ¨¡å¼ H1 ä¿®æ­£ */
        html[data-theme="light"] h1 {
            border-bottom: 3px solid var(--primary-color); /* æ›´ç²—çš„çº¿æ¡ */
            border-radius: 2px;
            letter-spacing: 1px; /* é—´è·ç´§å‡‘ä¸€ç‚¹ */
        }

        .config-group { margin-bottom: 20px; text-align: center; width: 85%; }
        .config-title { color: var(--secondary-color); font-size: 0.7rem; margin-bottom: 8px; display: block; }
        .btn-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .btn-group button { flex: 1; padding: 10px 0; font-size: 0.8rem; min-width: 80px; }
        #start-btn { margin-top: 30px; font-size: 1.1rem; padding: 12px 50px; border-color: var(--primary-color); }
        html[data-theme="light"] #start-btn { 
            background: var(--primary-color); color: #fff; box-shadow: 0 5px 20px rgba(255,143,171,0.4);
        }

        /* --- å³ä¸Šè§’æ§åˆ¶åŒº --- */
        .top-controls {
            position: absolute !important;
            top: 20px;
            right: 20px;
            z-index: 102;
            display: flex;
            gap: 10px;
        }

        .top-btn {
            padding: 8px 12px; 
            min-width: auto;
            margin: 0 !important;
            font-size: 0.75rem;
        }

        /* --- æ¸¸æˆä¸»ç•Œé¢ --- */
        #game-ui { display: none; flex-direction: column; width: 100%; flex: 1; min-height: 0; }

        .top-bar {
            min-height: 50px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 20px;
            background: rgba(0, 243, 255, 0.03);
            border-bottom: 1px solid rgba(0, 243, 255, 0.1);
            flex-shrink: 0; flex-wrap: wrap; gap: 10px;
            
            border-top-left-radius: var(--radius-main);
            border-top-right-radius: var(--radius-main);
        }
        html[data-theme="light"] .top-bar {
            background: rgba(255,255,255,0.8);
            border-bottom: 1px solid #eee;
        }

        .stat-group { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .stat-item { display: flex; flex-direction: row; gap: 8px; align-items: baseline; }
        .stat-label { font-size: 0.7rem; color: var(--secondary-color); }
        .stat-val { font-size: 1rem; font-weight: bold; min-width: 25px; text-shadow: var(--text-glow) var(--primary-color); }
        html[data-theme="light"] .stat-val { color: var(--text-color); }
        
        .menu-btns { display: flex; gap: 10px; }
        .menu-btns button { padding: 5px 12px; font-size: 0.7rem; height: 30px; }

        @media (max-width: 600px) {
            .top-bar { justify-content: center; padding: 10px; }
            .stat-group { width: 100%; justify-content: space-around; border-bottom: 1px dashed rgba(0, 243, 255, 0.1); padding-bottom: 8px; margin-bottom: 2px; }
            .menu-btns { width: 100%; justify-content: center; }
            .stat-group { gap: 10px; }
            h1 { font-size: 1.8rem; }
        }

        .progress-area { height: 4px; width: 100%; background: #111; position: relative; flex-shrink: 0; }
        html[data-theme="light"] .progress-area { background: #eee; }
        #timer-bar { 
            height: 100%; 
            background: var(--primary-color); 
            width: 0%; /* é»˜è®¤ä»0å¼€å§‹ */
            transition: width 0.1s linear; /* é…åˆ JS çš„ 100ms æ›´æ–°é¢‘ç‡ï¼Œä¿æŒä¸æ»‘ */
        }

        /* --- å¡ç‰ŒåŒº --- */
        #card-container {
            flex: 1; display: flex; justify-content: center; align-items: center; align-content: center;
            flex-wrap: wrap; gap: 10px; padding: 15px; overflow-y: auto; position: relative;
            touch-action: none; user-select: none;
        }

        .card {
            width: var(--card-w); height: var(--card-h);
            border: 1px solid var(--secondary-color);
            background: var(--card-bg); /* ä½¿ç”¨å˜é‡ */
            color: var(--secondary-color);
            display: flex; justify-content: center; align-items: center;
            font-size: 1.8rem; font-weight: bold;
            cursor: pointer; position: relative; 
            
            transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.1s ease-out, background-color 0.6s ease-out, border-color 0.6s ease-out, color 0.6s ease-out, box-shadow 0.6s ease-out;
            
            clip-path: polygon(6px 0, 100% 0, 100% calc(100% - 6px), calc(100% - 6px) 100%, 0 100%, 0 6px);
            user-select: none; -webkit-user-select: none;
            
            opacity: 1; transform: translateY(0) scale(1);
        }
        
        /* äº®è‰²æ¨¡å¼å¡ç‰Œä¿®æ­£ï¼šåœ†è§’ã€å®å¿ƒ */
        html[data-theme="light"] .card {
            clip-path: none;
            border-radius: 12px;
            border: 2px solid #f0f0f0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            color: #555;
        }

        .card.card-hidden {
            opacity: 0; transform: translateY(-60px) scale(1.1); pointer-events: none;
            background-color: var(--primary-color) !important;
            color: #000 !important;
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 30px var(--primary-color) !important;
        }
        /* äº®è‰²æ¨¡å¼éšèº«å¡ç‰Œä¿®æ­£ï¼šç™½è‰²æ–‡å­— */
        html[data-theme="light"] .card.card-hidden {
            color: #fff !important;
            box-shadow: 0 10px 30px rgba(255, 143, 171, 0.6) !important;
        }

        .card:hover { 
            background: rgba(0, 243, 255, 0.15); border-color: var(--primary-color); color: var(--primary-color); box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
            transform: translateY(-2px);
        }
        html[data-theme="light"] .card:hover {
            background: #fff;
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .card.selected {
            transform: translateY(-12px);
            border-color: #fff; color: #fff;
            background: rgba(0, 243, 255, 0.25); box-shadow: 0 0 15px var(--primary-color); z-index: 5;
        }
        html[data-theme="light"] .card.selected {
            background: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 8px 25px rgba(255, 143, 171, 0.6);
            transform: translateY(-10px);
        }
        
        /* æŒ‰é”®æç¤ºé€šç”¨æ ·å¼ */
        .key-hint {
            position: absolute; top: 2px; left: 5px; font-size: 0.6rem;
            font-family: inherit; font-weight: bold; line-height: 1; z-index: 10;
            color: currentColor; opacity: 0.5; transition: opacity 0.2s, color 0.2s; pointer-events: none;
        }

        html[data-theme="light"] .key-hint {
            top: 6px;   /* åŸæœ¬æ˜¯ 2px */
            left: 10px; /* åŸæœ¬æ˜¯ 5px */
        }
        
        button:hover .key-hint, button.active .key-hint, button.ready .key-hint { opacity: 0.8; }
        .hint-hide { display: none !important; }
        .card .key-hint { top: 4px; left: 6px; color: var(--primary-color); opacity: 0.8; }
        html[data-theme="light"] .card .key-hint { color: var(--text-color); opacity: 0.4; }
        button { position: relative !important; }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .bottom-bar {
            min-height: 70px; height: auto;
            display: flex; align-items: center; justify-content: flex-end;
            gap: 15px; padding: 10px 20px;
            border-top: 1px solid rgba(0, 243, 255, 0.1); background: rgba(0,0,0,0.2);
            flex-shrink: 0; flex-wrap: wrap; padding-bottom: calc(10px + env(safe-area-inset-bottom));
            
            border-bottom-left-radius: var(--radius-main);
            border-bottom-right-radius: var(--radius-main);
        }
        html[data-theme="light"] .bottom-bar {
            background: #fff; border-top: 1px solid #f0f0f0;
        }

        #msg-display { margin-right: auto; color: var(--secondary-color); font-size: 0.8rem; letter-spacing: 2px; width: 100%; text-align: center; margin-bottom: 5px; }
        @media (min-width: 601px) { #msg-display { width: auto; margin-bottom: 0; text-align: left; } }
        
        #btn-exec { min-width: 100px; }
        #btn-exec.ready { background: var(--primary-color); color: #000; box-shadow: 0 0 20px var(--primary-color); animation: pulse 1.5s infinite; }
        html[data-theme="light"] #btn-exec.ready { color: #fff; }
        
        @keyframes pulse { 50% { opacity: 0.7; box-shadow: 0 0 5px var(--primary-color); } }

        .suggest {
            background: var(--primary-color) !important; color: #000 !important;
            box-shadow: 0 0 20px var(--primary-color); animation: pulse 1.5s infinite; border-color: #fff !important;
        }
        html[data-theme="light"] .suggest { color: #fff !important; }

        #game-ui {
            position: relative;
        }

        #btn-all { 
            display: none; 
            
            position: absolute;    
            right: 20px;
            bottom: 15px;
        
            align-items: center;
            gap: 6px;       

            align-self: flex-end; 
            width: auto;
        
            border-radius: var(--radius-main); 
            
            background: rgba(0, 243, 255, 0.15);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            
            backdrop-filter: blur(4px);
        }
        
        html[data-theme="light"] #btn-all {
            background: rgba(255, 255, 255, 0.9) !important;
            border-color: var(--primary-color);
            color: var(--primary-color) !important;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1) !important;
        }

        /* æš—è‰²æ¨¡å¼ Hover */
        #btn-all:hover { 
            background: var(--primary-color); 
            color: #000; 
            box-shadow: 0 0 20px var(--primary-color);
        }

        /* === ä¿®å¤ï¼šäº®è‰²æ¨¡å¼ä¸‹è¦†ç›–æ‰è“å…‰ === */
        html[data-theme="light"] #btn-all {
            /* 1. èƒŒæ™¯æ”¹å›çº¯ç™½ */
            background: #fff !important; 
            
            /* 2. é˜´å½±æ”¹å›æŸ”å’Œçš„ç²‰è‰² (æˆ–è€…æ˜¯é€æ˜)ï¼Œå»æ‰åŸæœ¬çš„è“è‰²å‘å…‰ */
            box-shadow: 0 2px 8px rgba(255, 143, 171, 0.3) !important;
            
            /* 3. è¾¹æ¡†å’Œæ–‡å­—è·Ÿéšä¸»é¢˜è‰²(ç²‰è‰²) */
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* äº®è‰²æ¨¡å¼ Hover */
        html[data-theme="light"] #btn-all:hover {
            background: var(--primary-color) !important; 
            color: #fff !important;
            box-shadow: 0 5px 15px rgba(255, 143, 171, 0.6) !important;
        }

        /* åˆ©ç”¨ ID+ç±»å ç»„åˆï¼Œå¼ºåˆ¶å¤ç”¨å…¨å±€ .suggest çš„æ ·å¼ */
        #btn-all.suggest {
            /* 1. ç…§æ¬å…¨å±€ .suggest çš„å¤–è§‚ */
            background: var(--primary-color) !important;
            color: #000 !important; 
            border-color: #fff !important;
            
            /* 2. å¤ç”¨å…¨å±€å·²æœ‰çš„ pulse åŠ¨ç”» */
            animation: pulse 1.5s infinite !important;
            
            /* 3. è¦†ç›–æ‰ #btn-all åŸæœ¬çš„é˜´å½± */
            box-shadow: 0 0 20px var(--primary-color) !important;
            
            /* ä¿æŒå±‚çº§ */
            z-index: 100 !important;
        }
        
        /* äº®è‰²æ¨¡å¼é€‚é… (å¤ç”¨é€»è¾‘) */
        html[data-theme="light"] #btn-all.suggest {
            background: var(--primary-color) !important;
            color: #fff !important; 
        }
        
        #btn-clear { display: none; border-color: var(--alert-color); color: var(--alert-color); background: rgba(255, 42, 109, 0.1); margin-right: 5px; }
        #btn-clear:hover { background: var(--alert-color); color: #000; }
        html[data-theme="light"] #btn-clear { background: #fff; }
        html[data-theme="light"] #btn-clear:hover { background: var(--alert-color); color: #fff; }

        .footer-bar {
            height: calc(40px + env(safe-area-inset-bottom)); padding-bottom: env(safe-area-inset-bottom);
            flex-shrink: 0; display: flex; justify-content: center; align-items: center;
            border-top: 1px solid rgba(0, 243, 255, 0.05); background: rgba(0, 0, 0, 0.4);
            color: var(--secondary-color); font-size: 0.6rem; letter-spacing: 2px; text-shadow: var(--text-glow) var(--primary-color);
            animation: text-breathe 4s infinite ease-in-out;
        }
        html[data-theme="light"] .footer-bar { background: transparent; border: none; animation: none; color: #aaa; }
        @keyframes text-breathe { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.8; text-shadow: 0 0 8px var(--primary-color); } }

        #game-over, #review-ui {
            display: none; position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(2, 4, 8, 0.98); z-index: 999;
            flex-direction: column; align-items: center; justify-content: center;
            border-radius: var(--radius-main);
        }
        html[data-theme="light"] #game-over, 
        html[data-theme="light"] #review-ui { 
            background: rgba(255, 255, 255, 0.95); 
        }

        .title-success { font-size: 3rem; color: var(--success-color); text-shadow: var(--text-glow) var(--success-color); margin-bottom: 10px; text-align: center; }
        .title-failure { font-size: 3rem; color: var(--alert-color); text-shadow: var(--text-glow) var(--alert-color), 0 0 10px var(--alert-color); margin-bottom: 10px; text-align: center; }
        .end-stat { font-size: 1rem; color: var(--text-color); margin-bottom: 5px; }

        #review-ui { align-items: stretch; flex-direction: row; background: #000; }
        #review-list { width: 180px; border-right: 1px solid #333; overflow-y: auto; background: rgba(0, 243, 255, 0.02); }
        html[data-theme="light"] #review-ui { background: #fff; }
        html[data-theme="light"] #review-list { background: #f9f9f9; border-right: 1px solid #eee; }

        .log-entry { padding: 15px; border-bottom: 1px solid #222; font-size: 0.75rem; color: #666; cursor: pointer; text-align: right; }
        html[data-theme="light"] .log-entry { border-bottom: 1px solid #eee; color: #999; }
        
        .log-entry:hover, .log-entry.active { background: #111; color: var(--primary-color); border-right: 3px solid var(--primary-color); }
        html[data-theme="light"] .log-entry:hover, 
        html[data-theme="light"] .log-entry.active { background: #fff; }

        #review-detail { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        #review-display { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; justify-content: center; width: 100%; padding-top: 20px; }
        #review-display.mini-view { gap: 10px; margin-bottom: 20px; }
        #review-display.mini-view .card { width: 50px; height: 75px; font-size: 1.4rem; border-width: 1px; }
        #review-display.mini-view .card.selected { transform: translateY(-8px) !important; }

        #review-sol {
            font-size: 1.1rem; 
            color: var(--primary-color);
            
            /* === æ–°å¢/ä¿®æ”¹ï¼šå¼ºåˆ¶ä¸æ¢è¡Œä¸å±…ä¸­ === */
            white-space: nowrap;      /* ç¦æ­¢æ¢è¡Œ */
            width: 90%;               /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œç•™å‡ºå·¦å³è¾¹è· */
            max-width: 100%;          /* é˜²æ­¢æ’‘ç ´å®¹å™¨ */
            margin: 0 auto;           /* å±…ä¸­ */
            text-align: center;       /* æ–‡å­—å±…ä¸­ */
            
            /* å‡†å¤‡ç¼©æ”¾ */
            transform-origin: center; /* ä»ä¸­å¿ƒå¼€å§‹ç¼©æ”¾ */
            transition: transform 0.1s ease-out; /* ç¼©æ”¾æ—¶çš„å¹³æ»‘è¿‡æ¸¡ */
            display: block;           /* ç¡®ä¿ transform ç”Ÿæ•ˆ */
        }

        /* === æ­¥éª¤è§£æå™¨æ ·å¼ === */
        #step-container {
            width: 100%; max-width: 320px;
            margin-top: 15px;
            border-top: 1px dashed rgba(255,255,255,0.1);
        }
        
        #btn-toggle-steps {
            background: none; border: none;
            color: var(--secondary-color);
            font-size: 0.75rem; letter-spacing: 1px;
            padding: 10px 0; width: 100%; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 5px;
            opacity: 0.7; transition: opacity 0.3s;
        }
        #btn-toggle-steps:hover { opacity: 1; color: var(--primary-color); }
        #btn-toggle-steps svg { transition: transform 0.3s; }
        #btn-toggle-steps.open svg { transform: rotate(180deg); }

        #step-list {
            max-height: 0; overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0, 1, 0, 1); /* ä¸æ»‘æŠ˜å  */
            display: flex; flex-direction: column; gap: 8px;
            align-items: center;
        }
        #step-list.open { max-height: 300px; padding-bottom: 20px; }

        .step-row {
            font-family: var(--font-main);
            font-size: 0.9rem; color: #888;
            display: flex; align-items: center; gap: 4px;
        }

        /* === æ ¸å¿ƒé¢œè‰²å®šä¹‰ === */
        /* é¢œè‰²1: åŸå¡ç‰Œ (æµ…ç°/ç™½) */
        .num-c1 { color: var(--text-color); font-weight: bold; }
        /* é¢œè‰²2: ç¬¬ä¸€æ­¥ç»“æœ (æ·¡è“) */
        .num-c2 { color: #4facfe; font-weight: bold; }
        /* é¢œè‰²3: ç¬¬äºŒæ­¥ç»“æœ (æ·¡ç´«) */
        .num-c3 { color: #a18cd1; font-weight: bold; }
        /* é¢œè‰²4: æœ€ç»ˆç»“æœ (äº®é‡‘/ä¸»è‰²) */
        .num-c4 { color: var(--primary-color); font-weight: bold; text-shadow: 0 0 5px rgba(0,243,255,0.3); }
        
        /* è¿ç®—ç¬¦é¢œè‰² */
        .op-symbol { color: var(--secondary-color); font-weight: normal; margin: 0 2px; }

        /* äº®è‰²æ¨¡å¼å¾®è°ƒ */
        html[data-theme="light"] .num-c1 { color: #555; }
        html[data-theme="light"] .num-c2 { color: #0096c7; }
        html[data-theme="light"] .num-c3 { color: #7209b7; }
        html[data-theme="light"] .num-c4 { text-shadow: 0 0 5px rgba(255, 105, 180, 0.4); }
        html[data-theme="light"] #step-container { border-top: 1px dashed #ddd; }

        /* å¤´åƒæŒ‚ä»¶æ ·å¼ (ä¿æŒ) */
        #profile-link {
            position: absolute; top: 20px; left: 20px;
            display: flex; align-items: center; gap: 10px; text-decoration: none;
            z-index: 101; transition: all 0.3s ease; cursor: pointer; user-select: none;
        }
        #profile-link:hover { filter: brightness(1.2); }
        #profile-link:hover img { box-shadow: 0 0 20px var(--primary-color); transform: scale(1.05) rotate(5deg); }
        #profile-link img {
            width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--primary-color);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); background: #000; object-fit: cover; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .profile-info { display: flex; flex-direction: column; gap: 2px; }
        .profile-name { color: var(--text-color); font-size: 0.9rem; font-weight: bold; text-shadow: var(--text-glow) rgba(0, 243, 255, 0.5); font-family: var(--font-main); }
        .profile-role { color: var(--secondary-color); font-size: 0.6rem; letter-spacing: 2px; font-weight: bold; }

        /* ä¿®å¤ï¼šäº®è‰²æ¨¡å¼ä¸‹å¤´åƒçš„é˜´å½± */
        html[data-theme="light"] #profile-link img {
            /* 1. è¾¹æ¡†è·Ÿéšä¸»é¢˜è‰² (ç²‰è‰²) */
            border-color: var(--primary-color);
            
            /* 2. é˜´å½±æ”¹ä¸ºæŸ”å’Œçš„ç²‰è‰²æŠ•å½±ï¼Œå»æ‰é’è‰²å‘å…‰ */
            box-shadow: 0 4px 10px rgba(255, 143, 171, 0.4);
        }

        /* ä¿®å¤ï¼šäº®è‰²æ¨¡å¼ä¸‹åå­—å»æ‰éœ“è™¹å‘å…‰ */
        html[data-theme="light"] .profile-name {
            color: var(--text-color); /* æ·±ç°è‰² */
            text-shadow: none;        /* å…³æ‰å‘å…‰ */
            font-weight: 800;         /*ç¨å¾®åŠ ç²—ä¸€ç‚¹å¼¥è¡¥å»å‘å…‰åçš„è§†è§‰é‡é‡ */
        }

        /* ä¿®å¤ï¼šäº®è‰²æ¨¡å¼ä¸‹è§’è‰²å (LINK START) */
        html[data-theme="light"] .profile-role {
            color: #999; /* æµ…ç°è‰² */
        }

        /* ä¿®å¤ï¼šäº®è‰²æ¨¡å¼ä¸‹å¤´åƒ Hover çš„æ•ˆæœ */
        html[data-theme="light"] #profile-link:hover img {
            /* ç¨å¾®åŠ æ·±é˜´å½± */
            box-shadow: 0 6px 15px rgba(255, 143, 171, 0.6);
            transform: scale(1.05) rotate(5deg);
        }
        
        /* ç§»åŠ¨ç«¯é€‚é…ï¼šå±å¹•å˜çª„æ—¶ */
        @media (max-width: 600px) {
            /* 1. ä¸å†éšè—æ•´ä¸ªè¿æ¥ï¼Œè€Œæ˜¯è®©å®ƒä¿æŒæ˜¾ç¤º */
            #profile-link { 
                display: flex; 
                /* ç¨å¾®è°ƒæ•´ä½ç½®ï¼Œé€‚é…æ‰‹æœºçª„è¾¹æ¡† */
                top: 15px;
                left: 15px;
            }

            /* 2. åªéšè—æ–‡å­—éƒ¨åˆ† */
            #profile-link .profile-info { 
                display: none; 
            }

            /* 3. (å¯é€‰) å¤´åƒç¨å¾®ç¼©å°ä¸€ç‚¹ç‚¹ï¼Œæ˜¾å¾—æ›´ç²¾è‡´ */
            #profile-link img {
                width: 40px;
                height: 40px;
            }
        }

        /* === çª—å£æŠ–åŠ¨åŠ¨ç”» === */
        @keyframes shake-window {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-6px); }
            75% { transform: translateX(6px); }
        }

        /* æ¿€æ´»æŠ–åŠ¨çš„ç±» */
        .anim-shake {
            /* 0.2ç§’å¿«é€ŸæŠ–åŠ¨ï¼Œè¦†ç›–åŸæœ¬çš„ transition */
            animation: shake-window 0.2s ease-in-out;
        }

        /* === æ•™ç¨‹ç•Œé¢æ ·å¼ (ç‹¬ç«‹å‘½åç©ºé—´ï¼Œé˜²æ­¢å†²çª) === */
        #rules-ui {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--win-bg); z-index: 200;
            flex-direction: column; border-radius: var(--radius-main); overflow: hidden;
        }
        
        .rules-content {
            flex: 1; padding: 20px 25px; overflow-y: auto; text-align: left;
            scrollbar-width: thin; scrollbar-color: var(--secondary-color) transparent;
        }
        .rules-content::-webkit-scrollbar { width: 6px; }
        .rules-content::-webkit-scrollbar-thumb { background-color: var(--secondary-color); border-radius: 4px; }
        
        /* å±€éƒ¨ Header æ ·å¼ï¼Œä¸å½±å“å…¨å±€ H1 */
        #rules-ui header { text-align: center; margin-bottom: 25px; border-bottom: 1px solid var(--secondary-color); padding-bottom: 15px; }
        #rules-ui h1 { font-size: 1.8rem; border: none; margin-bottom: 5px; text-shadow: none; letter-spacing: 2px; }
        
        .subtitle { color: var(--secondary-color); font-size: 0.8rem; letter-spacing: 2px; margin-bottom: 10px; text-align: center; }
        .target-badge { 
            display: inline-block; background: var(--primary-color); color: var(--bg-color); 
            padding: 4px 12px; font-size: 0.8rem; font-weight: bold; border-radius: 4px; 
        }
        html[data-theme="light"] .target-badge { color: #fff; }
        
        .rule-section { margin-bottom: 25px; }
        .rule-section h2 { 
            font-size: 1.1rem; color: var(--text-color); border-left: 4px solid var(--primary-color); 
            padding-left: 10px; margin: 0 0 10px 0; text-transform: uppercase;
        }
        .rule-section h3 { font-size: 0.9rem; color: var(--secondary-color); margin: 5px 0; font-weight: bold; }
        /* é˜²æ­¢å…¨å±€ p æ ‡ç­¾æ ·å¼å¹²æ‰° */
        .rule-section p, .rule-section li { font-size: 0.85rem; line-height: 1.6; color: #888; margin: 5px 0; list-style-position: inside; }
        html[data-theme="light"] .rule-section p, html[data-theme="light"] .rule-section li { color: #666; }
        
        .highlight { color: var(--primary-color); font-weight: bold; }
        .success { color: var(--success-color); }
        .danger { color: var(--alert-color); }
        
        /* æ­¥éª¤ç½‘æ ¼ */
        .step-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 500px) { .step-list { grid-template-columns: 1fr; } }
        
        .step { 
            background: rgba(0,0,0,0.1); padding: 10px; border-radius: 4px; border: 1px dashed var(--secondary-color); 
        }
        html[data-theme="light"] .step { background: #f9f9f9; border: 1px dashed #ddd; }
        
        /* è§„åˆ™å¡ç‰‡ç½‘æ ¼ (é‡å‘½åä¸º rule-card é¿å…ä¸æ¸¸æˆå¡ç‰Œ .card å†²çª) */
        .rule-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .rule-grid.three-col { grid-template-columns: 1fr 1fr 1fr; }
        
        .rule-card { 
            border: 1px solid var(--secondary-color); background: var(--card-bg); 
            padding: 10px 5px; text-align: center; border-radius: var(--radius-main);
            display: flex; flex-direction: column; justify-content: center;
        }
        .rc-title { font-size: 0.75rem; color: var(--primary-color); font-weight: bold; margin-bottom: 4px; }
        .rc-content { font-size: 0.7rem; color: var(--text-color); opacity: 0.8; line-height: 1.4; }
        
        .warning-section { 
            border: 1px solid var(--alert-color); background: rgba(255, 42, 109, 0.05); 
            padding: 15px; border-radius: var(--radius-main);
        }
        .warning-section p:last-child {
            margin-bottom: 0;
        }
        html[data-theme="light"] .warning-section { background: #fff0f0; }
        
        .rules-footer {
            padding: 15px; background: var(--win-bg); border-top: 1px solid var(--secondary-color);
            display: flex; justify-content: center; z-index: 10; flex-shrink: 0;
        }
        .close-btn { width: 100%; max-width: 200px; border-color: var(--primary-color) !important; }

        /* === ç­”æ¡ˆæµ®ç©ºåŠ¨ç”» === */
        .float-equation {
            position: fixed; /* ä½¿ç”¨ fixed ç¡®ä¿å§‹ç»ˆæ˜¾ç¤ºåœ¨å±å¹•æœ€ä¸Šå±‚ */
            top: 45%;        /* å¤§è‡´åœ¨å±å¹•ä¸­é—´åä¸Šä¸€ç‚¹çš„ä½ç½® */
            left: 50%;
            transform: translate(-50%, -50%); /* å±…ä¸­ä¿®æ­£ */
            
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            
            /* èµ›åšé£å…‰æ™• */
            text-shadow: 0 0 10px var(--primary-color), 0 0 20px var(--primary-color);
            
            z-index: 2000; /* ç¡®ä¿ç›–ä½æ‰€æœ‰ç•Œé¢å…ƒç´  */
            pointer-events: none; /* å…³é”®ï¼šç¡®ä¿ç‚¹å‡»èƒ½ç©¿é€å®ƒï¼Œä¸æŒ¡æ“ä½œ */
            
            /* åŠ¨ç”»å®šä¹‰ */
            animation: float2eases 1.6s forwards;
            
            /* ä¿æŒå•è¡Œæ˜¾ç¤º */
            white-space: nowrap; 
        }
        
        /* äº®è‰²æ¨¡å¼é€‚é…ï¼šå»æ‰éœ“è™¹å…‰ï¼Œæ”¹ç”¨æŸ”å’ŒæŠ•å½± */
        html[data-theme="light"] .float-equation {
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
            color: var(--primary-color); /* ç²‰è‰² */
        }
        
        @keyframes float2eases{
            0%{
                opacity: 0;
                transform: translate(-50%, -50%) translateY(0) scale(0.2);
                animation-timing-function: cubic-bezier(.16, 1, .3, 1); /* å¸¸ç”¨çš„ expoOut è¿‘ä¼¼ */
            }
            50%{
                opacity: 1;
                transform: translate(-50%, -50%) translateY(-100px) scale(1);
                animation-timing-function: cubic-bezier(.55, .055, .675, .19); /* cubicIn */
            }
            100%{
                opacity: 0;
                transform: translate(-50%, -50%) translateY(-200px) scale(.98);
            }
        }
        
        @media (max-width: 600px), (max-height: 800px) { 
            /* 1. å®¹å™¨æ”¹ä¸ºå¼¹æ€§åˆ†å¸ƒ */
            #start-screen {
                /* å…³é”®ï¼šä½¿ç”¨ space-between æˆ– space-evenly è®©å…ƒç´ å‚ç›´å‡åŒ€åˆ†å¸ƒ */
                justify-content: space-evenly; 
                padding: 60px 0 30px 0; /* ä¸Šä¸‹ç•™å‡ºç©ºé—´ï¼Œé¿å¼€é¡¶éƒ¨æŒ‰é’®å’Œåº•éƒ¨ */
                height: 100%;           /* ç¡®ä¿å æ»¡é«˜åº¦ */
                gap: 5px;               /* æœ€å°é—´è·ä¿æŠ¤ */
            }

            /* 2. æ ‡é¢˜å°ºå¯¸è°ƒæ•´ */
            h1 {
                font-size: 1.8rem;
                margin: 0;           /* å»æ‰ marginï¼Œå®Œå…¨ç”±çˆ¶å®¹å™¨åˆ†é…ç©ºé—´ */
                flex-shrink: 0;      /* é˜²æ­¢æ ‡é¢˜è¢«å‹ç¼©æ²¡äº† */
            }

            /* 3. é€‰é¡¹ç»„ï¼šç§»é™¤å¤–è¾¹è·ï¼Œæ”¹ç”¨å¼¹æ€§é«˜åº¦ */
            .config-group {
                margin: 0;           /* ç§»é™¤ margin-bottomï¼Œäº¤ç»™çˆ¶å®¹å™¨ gap æ§åˆ¶ */
                width: 90%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                /* å…è®¸ç¨å¾®å‹ç¼©ï¼Œä½†ä¸å…è®¸å‹å¾—å¤ªæ‰ */
                flex-shrink: 1;      
            }

            /* 4. é€‰é¡¹æ ‡é¢˜å¾®è°ƒ */
            .config-title {
                margin-bottom: 4px;
                font-size: 0.7rem;
            }

            /* 5. æŒ‰é’®ç»„æ ·å¼ */
            .btn-group button {
                padding: 8px 0;      /* ä¿æŒé€‚ä¸­çš„ç‚¹å‡»åŒºåŸŸ */
                font-size: 0.8rem;
            }

            /* 6. å¯åŠ¨æŒ‰é’® */
            #start-btn {
                margin: 10px 0 0 0;
                padding: 9px 40px;
                display: block;
                flex-shrink: 0;      /* ä¿è¯æŒ‰é’®ä¸è¢«å‹ç¼© */
            }

            /* 7. é¡¶éƒ¨æ§ä»¶é˜²é®æŒ¡ */
            .top-controls { top: 10px; right: 10px; }
            #profile-link { top: 10px; left: 10px; }
            #profile-link img { width: 36px; height: 36px; }
        }

        /* === ä¿®å¤ï¼šçŸ®å±å¹•é€‚é… (å½»åº•è§£å†³æ— æ³•æ»šåŠ¨åˆ°åº•éƒ¨çš„é—®é¢˜) === */
        @media (max-height: 550px) {

        /* å…³é”®ï¼šå…è®¸ start-screen åœ¨ flex å¸ƒå±€é‡Œâ€œå˜çŸ®â€ */
        #start-screen{
            min-height: 0;           /* æ²¡è¿™å¥ç»å¸¸æ»šä¸åŠ¨æˆ–æ»šä¸åˆ°åº• */
            flex: 1;
            overflow-y: auto;
            
            /* å†…å®¹å¸ƒå±€ï¼šä»ä¸Šå¼€å§‹æ’ï¼Œé¿å…å±…ä¸­å¯¼è‡´ä¸Šä¸‹æµªè´¹ç©ºé—´ */
            justify-content: flex-start;
        
            /* ç»™é¡¶éƒ¨æ§ä»¶/å¤´åƒç•™ç©ºé—´ */
            padding-top: 70px;
            padding-bottom: 20px;
            gap: 8px;
          }
        
          /* æ ‡é¢˜/é…ç½®å—ä¸è¦è¢«å‹æ‰åˆ°ä¸å¯è¯» */
          .config-group, h1, #start-btn{
            flex-shrink: 0;
          }
        }
    </style>
</head>
    
<body>
    <div id="main-window">
        <!-- å¯åŠ¨èœå• -->
        <div id="start-screen">
            <a id="profile-link" href="/">
                <img src="/avatar.jpg" alt="Avatar">
                <div class="profile-info">
                    <span class="profile-name" data-i18n="profile_back">å›åˆ°ä¸»é¡µ</span>
                    <span class="profile-role" data-i18n="profile_role">è¿æ¥å¯åŠ¨</span>
                </div>
            </a>

            <!-- å³ä¸Šè§’æ§åˆ¶åŒº -->
            <div class="top-controls">
                <button id="sound-btn" onclick="toggleSound()" class="top-btn" aria-label="Toggle Sound">
                    <svg id="icon-sound-on" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="display:block">
                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                    </svg>
                </button>
                
                <button id="lang-btn" onclick="toggleLanguage()" class="top-btn" data-i18n="lang_btn">
                    English
                </button>
                <button id="rules-btn" onclick="toggleRules()" class="top-btn" data-i18n="btn_help">
                    HELP
                </button>
                <button id="theme-btn-main" onclick="toggleTheme()" class="top-btn" data-i18n="theme_btn">
                    ç‚¹ç¼€
                </button>
            </div>
            
            <h1>PROJECT: 24</h1>

            <div class="config-group">
                <span class="config-title" data-i18n="lbl_target">TARGET</span>
                <div class="btn-group" id="opt-target">
                    <button class="active" data-val="24">24</button>
                    <button data-val="36">36</button>
                    <button data-val="60">60</button>
                </div>
            </div>
            <div class="config-group">
                <span class="config-title" data-i18n="lbl_dataset">DATASET</span>
                <div class="btn-group" id="opt-deck">
                    <button data-val="simple" data-i18n="btn_simple">ç®€å•</button>
                    <button data-val="classic" data-i18n="btn_classic">ç»å…¸</button>
                    <button class="active" data-val="standard" data-i18n="btn_standard">æ ‡å‡†</button>
                </div>
            </div>
            <div class="config-group">
                <span class="config-title" data-i18n="lbl_timer">TIMER</span>
                <div class="btn-group" id="opt-time">
                    <button class="active" data-val="endless" data-i18n="btn_endless">æ— å°½</button>
                    <button data-val="hourglass" data-i18n="btn_hourglass">æ²™æ¼</button>
                    <button data-val="breathing" data-i18n="btn_breathing">å‘¼å¸</button>
                </div>
            </div>
            <div class="config-group">
                <span class="config-title" data-i18n="lbl_tolerance">TOLERANCE</span>
                <div class="btn-group" id="opt-life">
                    <button data-val="casual" data-i18n="btn_casual">ä¼‘é—² (3)</button>
                    <button class="active" data-val="challenge" data-i18n="btn_challenge">æŒ‘æˆ˜ (1)</button>
                    <button data-val="extreme" data-i18n="btn_extreme">æé™ (0)</button>
                </div>
            </div>
            <div class="config-group">
                <span class="config-title" data-i18n="lbl_length">LENGTH</span>
                <div class="btn-group" id="opt-rounds">
                    <button class="active" data-val="1" data-i18n="btn_base">åŸºç¡€ (1)</button>
                    <button data-val="10" data-i18n="btn_endurance">è€ä¹… (10)</button>
                    <button data-val="-1" data-i18n="btn_infinite">æ— é™ (âˆ)</button>
                </div>
            </div>
            <button id="start-btn" data-i18n="btn_start">INITIATE</button>
        </div>

        <!-- æ¸¸æˆç•Œé¢ -->
        <div id="game-ui">
            <div class="top-bar">
                <div class="stat-group">
                    <div class="stat-item" id="round-display" style="display:none">
                        <span class="stat-label" data-i18n="stat_rnd">RND:</span>
                        <span class="stat-val" id="round-val">1/1</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label" data-i18n="stat_deck">DECK:</span>
                        <span class="stat-val" id="deck-val">--</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label" data-i18n="stat_time">TIME:</span>
                        <span class="stat-val" id="time-val">00:00</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label" data-i18n="stat_chances">CHANCES:</span>
                        <span class="stat-val" id="chance-val" style="color:var(--alert-color)">--</span>
                    </div>
                </div>
                <div class="menu-btns">
                    <button onclick="getHint()" data-i18n="btn_hint">HINT</button>
                    <button onclick="startGame()" data-i18n="btn_restart">RESTART</button>
                    <button onclick="backToMenu()" data-i18n="btn_menu">MENU</button>
                </div>
            </div>
            <div class="progress-area">
                <div id="timer-bar"></div>
            </div>
            <div id="card-container"></div>

            <button id="btn-all" onclick="selectAllAndExec()">
                <span class="key-hint">â†µ</span><span data-i18n="btn_all">ALL IN</span>
            </button>
            
            <div class="bottom-bar">
                <div id="msg-display" data-i18n="msg_ready">SYSTEM READY</div>
                
                <button id="btn-clear" onclick="clearSelection()">
                    <span class="key-hint">ESC</span><span data-i18n="btn_clear">CLEAR</span>
                </button>
                
                <button id="btn-draw">
                    <span class="key-hint">Q</span><span data-i18n="btn_draw">DRAW</span>
                </button>
                
                <button id="btn-exec" disabled>
                    <span class="key-hint">â†µ</span><span data-i18n="btn_exec">EXECUTE</span>
                </button>
            </div>
        </div>

        <div class="footer-bar" data-i18n="footer">
            BUILD: 2025 // CREATOR: ç‚¹ç¼€æ˜Ÿç©º
        </div>

        <div id="rules-ui">
            <div id="rules-zh" class="rules-content" style="display: block;">
                <header>
                    <h1>æ¸¸æˆè§„åˆ™</h1>
                </header>
                
                <div class="rule-section">
                    <h2>ğŸ¯ æ ¸å¿ƒç›®æ ‡</h2>
                    <p>ä½¿ç”¨æ‰‹ç‰Œä¸­çš„æ•°å­—ï¼Œé€šè¿‡ <strong class="highlight">åŠ å‡ä¹˜é™¤</strong>ï¼ˆå¯ä»»æ„ä½¿ç”¨æ‹¬å·ã€å…è®¸ä¸­é—´å‡ºç°è´Ÿæ•°æˆ–å°æ•°ï¼‰è®¡ç®—å‡º <strong class="highlight dyn-target">24</strong>ï¼Œå¹¶æ¸…ç©ºæ‰€æœ‰æ‰‹ç‰Œã€‚</p>
                </div>
                
                <div class="rule-section">
                    <h2>ğŸ“ åŸºæœ¬æµç¨‹</h2>
                    <div class="step-list">
                        <div class="step">
                            <h3>1. å‡ºç‰Œ</h3>
                            <p>é€‰æ‹© <strong class="highlight">2ï½4 å¼ </strong>ç‰Œï¼Œç‚¹å‡» <strong>ã€Œæ‰§è¡Œã€</strong>ã€‚</p>
                        </div>
                        <div class="step">
                            <h3>2. æŠ½ç‰Œ</h3>
                            <p>ä¸çŸ¥é“å‡ºä»€ä¹ˆæ—¶å¯ä»¥æŠ½å–ä¸€å¼ ç‰ŒåŠ å…¥æ‰‹ç‰Œï¼Œæ‰‹ç‰Œä¸Šé™ä¸º <strong class="highlight">10å¼ </strong>ã€‚</p>
                        </div>
                        <div class="step">
                            <h3>3. æ‰§è¡Œ</h3>
                            <ul>
                                <li><span class="success">æˆåŠŸ</span>ï¼šè®¡ç®—å‡º<span class="dyn-target">24</span>ï¼Œç‰Œç§»é™¤ã€‚</li>
                                <li><span class="danger">å¤±è´¥</span>ï¼šæ— æ³•ç®—å‡º<span class="dyn-target">24</span>ï¼Œæ‰£é™¤æœºä¼šã€‚</li>
                            </ul>
                        </div>
                        <div class="step">
                            <h3>4. èƒœåˆ©</h3>
                            <p>æ¸…ç©ºæ‰‹ç‰Œå³å®Œæˆå½“å‰è½®æ¬¡ã€‚</p>
                        </div>
                    </div>
                </div>
                
                <div class="rule-section">
                    <h2>ğŸƒ ç‰Œä¸ç‰Œåº“</h2>
                    <div class="rule-grid">
                        <div class="rule-card">
                            <div class="rc-title">æ•°å€¼è¯´æ˜</div>
                            <div class="rc-content">A=1, J=11, Q=12, K=13<br>å°ç‹=14, å¤§ç‹=15</div>
                        </div>
                        <div class="rule-card">
                            <div class="rc-title">ç‰Œåº“æ¨¡å¼</div>
                            <div class="rc-content">
                                <strong>ç®€å•</strong>ï¼šæ˜“è§£ç‰Œå¤š<br>
                                <strong>ç»å…¸</strong>ï¼šæ ‡å‡†æ‰‘å…‹<br>
                                <strong>æ ‡å‡†</strong>ï¼šå«å¤§å°ç‹(14/15)
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="rule-section">
                    <h2>âš™ï¸ æ¸¸æˆè®¾ç½®</h2>
                    <h3>å®¹é”™æœºä¼š</h3>
                    <div class="rule-grid three-col">
                        <div class="rule-card"><div class="rc-title">æé™</div><div class="rc-content">0 æ¬¡æœºä¼šï¼Œä¸å…è®¸å¤±è¯¯</div></div>
                        <div class="rule-card"><div class="rc-title">æŒ‘æˆ˜</div><div class="rc-content">1 æ¬¡æœºä¼š</div></div>
                        <div class="rule-card"><div class="rc-title">ä¼‘é—²</div><div class="rc-content">3 æ¬¡æœºä¼š</div></div>
                    </div>
                    
                    <h3 style="margin-top:10px">è®¡æ—¶æ¨¡å¼</h3>
                    <div class="rule-grid three-col">
                        <div class="rule-card"><div class="rc-title">æ— å°½</div><div class="rc-content">æ— é™åˆ¶ï¼Œè®¡æ—¶æ€»è€—æ—¶</div></div>
                        <div class="rule-card"><div class="rc-title">æ²™æ¼</div><div class="rc-content">60ç§’å€’è®¡æ—¶ï¼Œç»“æŸç«‹åˆ»å¤±è´¥</div></div>
                        <div class="rule-card"><div class="rc-title">å‘¼å¸</div><div class="rc-content">10ç§’å¿…é¡»å‡ºä¸€æ¬¡ï¼Œå¦åˆ™æ‰£é™¤æœºä¼š</div></div>
                    </div>

                    <h3 style="margin-top:10px">èµ›ç¨‹é•¿åº¦</h3>
                    <div class="rule-grid three-col">
                        <div class="rule-card"><div class="rc-title">æ— é™</div><div class="rc-content">æ— é™è½®æ¬¡ï¼Œè®°å½•è¾¾æˆè½®æ•°</div></div>
                        <div class="rule-card"><div class="rc-title">è€ä¹…</div><div class="rc-content">è¿ç»­æŒ‘æˆ˜ 10 è½®ï¼ŒæŒ‘æˆ˜é€šå…³é€Ÿåº¦</div></div>
                        <div class="rule-card"><div class="rc-title">åŸºç¡€</div><div class="rc-content">æ¸…ç©ºä¸€æ¬¡æ‰‹ç‰Œå³èƒœåˆ©</div></div>
                    </div>
                </div>
                
                <div class="rule-section warning-section">
                    <h3 class="danger" style="margin-top:0">âš ï¸ æ³¨æ„äº‹é¡¹</h3>
                    <p><strong>æ­»å±€ï¼š</strong>ç‰Œå †ç©ºä¸”æ‰‹ç‰Œæ— è§£æ—¶ï¼Œç«‹å³åˆ¤è´Ÿã€‚</p>
                    <p><strong>æç¤ºï¼š</strong>ä½¿ç”¨æç¤ºçš„å¯¹å±€å°†ä¸è®¡å…¥æœ€ä½³æˆç»©ã€‚</p>
                    <p><strong>å¤ç›˜ï¼š</strong>ç»“ç®—æ—¶å¯ä»¥æŸ¥çœ‹æ‰“å‡ºçš„æ‰€æœ‰ç‰Œç»„ã€å‚è€ƒè§£æ³•ã€å’Œå‰©ä½™æ‰‹ç‰Œã€‚</p>
                </div>
            </div>
        
            <div id="rules-en" class="rules-content" style="display: none;">
                <header>
                    <h1>GAME RULES</h1>
                </header>
                
                <div class="rule-section">
                    <h2>ğŸ¯ OBJECTIVE</h2>
                    <p>Use cards in hand to calculate <strong class="highlight dyn-target">24</strong> using <strong class="highlight">+ - Ã— Ã·</strong> (parentheses, negatives, decimals allowed). Clear all cards to win.</p>
                </div>
                
                <div class="rule-section">
                    <h2>ğŸ“ WORKFLOW</h2>
                    <div class="step-list">
                        <div class="step">
                            <h3>1. PLAY</h3>
                            <p>Select <strong class="highlight">2-4 cards</strong>, then click <strong>[EXECUTE]</strong>.</p>
                        </div>
                        <div class="step">
                            <h3>2. DRAW</h3>
                            <p>Draw a card when you are stuck. Hand limit is <strong class="highlight">10 cards</strong>.</p>
                        </div>
                        <div class="step">
                            <h3>3. EXECUTE</h3>
                            <ul>
                                <li><span class="success">SUCCESS</span>: Result is <span class="dyn-target">24</span>. Cards removed.</li>
                                <li><span class="danger">FAIL</span>: Result is not <span class="dyn-target">24</span>. Lose a chance.</li>
                            </ul>
                        </div>
                        <div class="step">
                            <h3>4. VICTORY</h3>
                            <p>Clear all cards to complete the wave.</p>
                        </div>
                    </div>
                </div>
                
                <div class="rule-section">
                    <h2>ğŸƒ CARDS & DECK</h2>
                    <div class="rule-grid">
                        <div class="rule-card">
                            <div class="rc-title">VALUES</div>
                            <div class="rc-content">A=1, J=11, Q=12, K=13<br>Joker(S)=14, Joker(L)=15</div>
                        </div>
                        <div class="rule-card">
                            <div class="rc-title">MODES</div>
                            <div class="rc-content">
                                <strong>SIMPLE</strong>: High frequency of easy numbers<br>
                                <strong>CLASSIC</strong>: Standard 4 suits (A-K)<br>
                                <strong>STANDARD</strong>: Adds Jokers (14/15)
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="rule-section">
                    <h2>âš™ï¸ SETTINGS</h2>
                    <h3>TOLERANCE</h3>
                    <div class="rule-grid three-col">
                        <div class="rule-card"><div class="rc-title">EXTREME</div><div class="rc-content">0 Chances. No errors allowed.</div></div>
                        <div class="rule-card"><div class="rc-title">STRICT</div><div class="rc-content">1 Chance.</div></div>
                        <div class="rule-card"><div class="rc-title">CASUAL</div><div class="rc-content">3 Chances.</div></div>
                    </div>
                    
                    <h3 style="margin-top:10px">TIMER</h3>
                    <div class="rule-grid three-col">
                        <div class="rule-card">
                            <div class="rc-title">ENDLESS</div>
                            <div class="rc-content">No time limit. Tracks elapsed time.</div>
                        </div>
                        <div class="rule-card">
                            <div class="rc-title">HOURGLASS</div>
                            <div class="rc-content">60s countdown. Instant fail on timeout.</div>
                        </div>
                        <div class="rule-card">
                            <div class="rc-title">BREATHING</div>
                            <div class="rc-content">10s per move. Timeout loses a chance.</div>
                        </div>
                    </div>
        
                    <h3 style="margin-top:10px">LENGTH</h3>
                    <div class="rule-grid three-col">
                        <div class="rule-card">
                            <div class="rc-title">INFINITE</div>
                            <div class="rc-content">Endless waves. Record: Max Waves.</div>
                        </div>
                        <div class="rule-card">
                            <div class="rc-title">STAMINA</div>
                            <div class="rc-content">10 waves marathon. Record: Total Time.</div>
                        </div>
                        <div class="rule-card">
                            <div class="rc-title">BASE</div>
                            <div class="rc-content">Standard mode. Clear deck to win.</div>
                        </div>
                    </div>
                </div>
                
                <div class="rule-section warning-section" style="margin-bottom: 0;">
                    <h3 class="danger" style="margin-top:0">âš ï¸ NOTES</h3>
                    
                    <p><strong>DEAD END:</strong> Instant loss if deck is empty & no moves remain.</p>
                    
                    <p><strong>HINT:</strong> Runs using HINT do not count toward records.</p>
                    
                    <p><strong>REVIEW:</strong> On the results screen, you can view all played card sets,
        sample solutions, and the remaining cards in your hand.</p>
                </div>
            </div>
            
            <div class="rules-footer">
                <button onclick="toggleRules()" class="close-btn" data-i18n="btn_close_rules">å…³é—­æŒ‡å— / CLOSE</button>
            </div>
        </div>
        
        <!-- ç»“ç®—ç•Œé¢ -->
        <div id="game-over">
            <div id="end-title" class="title-failure" data-i18n="fail_title">FAILURE</div>
            <div id="end-msg" style="margin-bottom:20px; letter-spacing:1px; color:#888" data-i18n="msg_signal_lost">SIGNAL LOST</div>
            <div id="end-time" class="end-stat" style="margin-bottom: 5px; font-weight: bold; color: var(--primary-color)"></div>
            <div id="end-record" class="end-stat" style="font-size: 0.8rem; color: #666; margin-bottom: 5px; letter-spacing: 1px;"></div>
        
            <div id="end-config" class="end-stat" style="font-size: 0.7rem; color: #555; margin-bottom: 5px; font-family: var(--font-main); text-transform: uppercase;"></div>
            <div id="end-clears" class="end-stat" style="font-size: 0.85rem; color: var(--secondary-color); margin-bottom: 30px; letter-spacing: 1px; font-weight:bold;"></div>
            <div style="display:flex; gap:15px; flex-wrap: wrap; justify-content: center;">    
                <button onclick="openReview()" data-i18n="btn_review">REVIEW</button>
                <button onclick="startGame()" data-i18n="btn_retry">RETRY</button>
                <button onclick="backToMenu()" data-i18n="btn_menu">MENU</button>
            </div>
        </div>

        <!-- å¤ç›˜ -->
        <div id="review-ui">
            <div id="review-list"></div>
            <div id="review-detail">
                <div id="review-display"></div>
                <div id="lbl-sol" style="color:#555; font-size:0.7rem; margin-bottom:15px;" data-i18n="lbl_sol_data">SOLUTION DATA</div>
                <div id="review-sol" style="font-size:1.1rem; color:var(--primary-color)">[DATA PENDING]</div>

                <div id="step-container" style="display:none">
                    <button id="btn-toggle-steps" onclick="toggleSteps()">
                        <span data-i18n="btn_details">DETAILS</span>
                        <svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor">
                            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                        </svg>
                    </button>
                    <div id="step-list">
                        </div>
                </div>
                
                <button onclick="closeReview()" style="margin-top:30px; border-color:var(--alert-color)" data-i18n="btn_close">
                    CLOSE
                </button>
            </div>
        </div>
    </div>

    <script>
        // å›¾æ ‡ SVG æ•°æ®
        const iconSoundOn = `<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
        const iconSoundOff = `<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>`;
        
        // === éŸ³é¢‘ç³»ç»Ÿï¼šæ³›éŸ³åˆ—åˆæˆå™¨ (Boostç‰ˆ) ===
        const AudioSys = {
            ctx: null,
            baseFreq: 207.65, // #G3
            masterGain: null,
            compressor: null, // æ–°å¢ï¼šå‹ç¼©å™¨

            muted: localStorage.getItem('p24_audio_muted') === 'true',
        
            init() {
                if (this.ctx) return;
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
        
                // 1. åˆ›å»ºåŠ¨æ€å‹ç¼©å™¨ (è¿™æ˜¯è®©å£°éŸ³å˜å¤§ä¸”ä¸ç ´éŸ³çš„å…³é”®)
                this.compressor = this.ctx.createDynamicsCompressor();
                this.compressor.threshold.value = -24; // è¶…è¿‡ -24dB å°±å¼€å§‹å‹ç¼©
                this.compressor.knee.value = 30;       // å¹³æ»‘è¿‡æ¸¡
                this.compressor.ratio.value = 12;      // å‹ç¼©æ¯”
                this.compressor.attack.value = 0.003;  // å“åº”é€Ÿåº¦
                this.compressor.release.value = 0.25;  // é‡Šæ”¾é€Ÿåº¦
        
                // 2. ä¸»éŸ³é‡
                this.masterGain = this.ctx.createGain();
                this.masterGain.gain.value = 0.8; // æå‡åˆ° 80% (ä¹‹å‰æ˜¯ 0.3)
        
                // 3. è¿æ¥çº¿è·¯ï¼šæ‰€æœ‰å£°éŸ³ -> å‹ç¼©å™¨ -> ä¸»éŸ³é‡ -> è¾“å‡º
                this.compressor.connect(this.masterGain);
                this.masterGain.connect(this.ctx.destination);
            },

            toggleMute() {
                this.muted = !this.muted;
                localStorage.setItem('p24_audio_muted', this.muted);
                
                // å¦‚æœéŸ³é¢‘ä¸Šä¸‹æ–‡å·²åˆå§‹åŒ–ï¼Œå®æ—¶è°ƒæ•´éŸ³é‡
                if (this.masterGain) {
                    // å¹³æ»‘è¿‡æ¸¡éŸ³é‡ï¼Œé˜²æ­¢çˆ†éŸ³
                    const t = this.ctx.currentTime;
                    this.masterGain.gain.cancelScheduledValues(t);
                    this.masterGain.gain.setValueAtTime(this.masterGain.gain.value, t);
                    
                    if (this.muted) {
                        this.masterGain.gain.linearRampToValueAtTime(0, t + 0.1);
                    } else {
                        this.masterGain.gain.linearRampToValueAtTime(0.8, t + 0.1);
                    }
                }
                
                // åˆå§‹åŒ–ä¸€ä¸‹ä»¥é˜²ä¸‡ä¸€
                if (!this.ctx && !this.muted) this.init();
                
                return this.muted;
            },

            playError() {
                if (this.muted) return;
                if (!this.ctx) this.init();
        
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
        
                // æ­£å¼¦æ³¢ä¿è¯äº†â€œæ¶¦â€
                osc.type = 'sine';
        
                // é¢‘ç‡ä»é«˜ç©º(1200Hz) æé€Ÿä¸‹æ½œåˆ° (200Hz)
                // è¿™ç§å¿«é€Ÿçš„éŸ³é«˜ä¸‹æ»‘æ˜¯æ ‡å‡†çš„â€œæ°´æ»´å£°â€ç‰©ç†ç‰¹æ€§
                osc.frequency.setValueAtTime(1200, t);
                osc.frequency.exponentialRampToValueAtTime(200, t + 0.15);
        
                // åŒ…ç»œï¼šéå¸¸çŸ­ä¿ƒ
                gain.gain.setValueAtTime(0, t);
                // éŸ³é‡ç»™è¶³ï¼Œå› ä¸ºæ­£å¼¦æ³¢å¾ˆæ¸©æŸ”
                gain.gain.linearRampToValueAtTime(0.8, t + 0.01); 
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
        
                osc.connect(gain);
                gain.connect(this.masterGain);
        
                osc.start(t);
                osc.stop(t + 0.15);
            },

            // æ™®é€šæŒ‰é’®çš„æœºæ¢°ç‚¹å‡»éŸ³ (Tick)
            playClick() {
                if (this.muted) return;
                if (!this.ctx) this.init();
        
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
        
                osc.type = 'sine';
                
                // å›ºå®šé«˜é¢‘ï¼Œä¸æ‰«é¢‘ï¼Œå¬èµ·æ¥æ›´åƒç”µå­ä¿¡å·
                osc.frequency.setValueAtTime(800, t); 
        
                // æå…¶çŸ­ä¿ƒçš„åŒ…ç»œ (0.03ç§’)
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(0.3, t + 0.005);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.03);
        
                osc.connect(gain);
                gain.connect(this.masterGain);
        
                osc.start(t);
                osc.stop(t + 0.03);
            },
            
            playTone(n, duration = 0.5, timeOffset = 0) {
                if (this.muted) return;
                
                if (!this.ctx) this.init();
                if (n <= 0) return;
        
                const t = this.ctx.currentTime + timeOffset;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
        
                osc.frequency.value = this.baseFreq * n;
                osc.type = 'sine'; // çº¯æ­£å¼¦
        
                gain.gain.setValueAtTime(0, t);
                
                // === ä¿®æ”¹ç‚¹ï¼šé«˜éŸ³æå¤§è¡°å‡ ===
                // ä½¿ç”¨ 1/n çš„è¡°å‡æ¨¡å¼
                const volume = 1 / n; 
        
                // æçŸ­çš„èµ·éŸ³
                gain.gain.linearRampToValueAtTime(volume, t + 0.005);
                
                // === ä¿®æ”¹ç‚¹ï¼šåŠ¨æ€æ—¶é•¿ ===
                // é«˜éŸ³(nå¤§) è¡°å‡å¾—æ¯” ä½éŸ³(nå°) æ›´å¿«
                // 1å·ç‰Œä½™éŸ³ 1.5ç§’ï¼Œ15å·ç‰Œä½™éŸ³åªæœ‰ 0.3ç§’
                const decayTime = 1.5 / Math.sqrt(n);
                gain.gain.exponentialRampToValueAtTime(0.001, t + decayTime);
        
                const panner = this.ctx.createStereoPanner();
                panner.pan.value = (Math.random() * 1.2) - 0.6;
        
                osc.connect(gain);
                gain.connect(panner);
                panner.connect(this.compressor); 
        
                osc.start(t);
                osc.stop(t + decayTime + 0.1);
            },
        
            playChord(numbers) {
                if (!this.ctx) this.init();
                // å’Œå¼¦æ—¶ï¼ŒæŠŠå•éŸ³æ—¶é•¿ç¨å¾®æ‹‰é•¿ä¸€ç‚¹ï¼Œè¥é€ ä½™éŸ³ç»•æ¢çš„æ„Ÿè§‰
                numbers.forEach((n, index) => {
                    this.playTone(n, 2.0, index * 0.1); 
                });
            },

            /**
             * æ¼”å¥çˆµå£«æ„Ÿç¶éŸ³
             * @param {Array} numbers - ç‰Œé¢æ•°å­—æ•°ç»„ [3, 6, 8, 12]
             */
            playJazzArpeggio(numbers) {
                if (this.muted || !this.ctx) return;
                
                // 1. ç¡®ä¿æ•°å­—ä»å°åˆ°å¤§æ’åºï¼Œæ„å»ºå’Œå¼¦ç»“æ„
                const sorted = [...numbers].sort((a, b) => a - b);
                
                // 2. è®¾å®šåŸºç¡€æ—¶é—´é”šç‚¹
                const now = this.ctx.currentTime;
                
                // 3. éå†æ¯ä¸ªéŸ³ç¬¦è¿›è¡Œè°ƒåº¦
                sorted.forEach((n, i) => {
                    // === çˆµå£«èŠ‚å¥ç®—æ³• ===
                    
                    // A. Swing æ‘‡æ‘†æ„Ÿè®¡ç®—
                    // å¶æ•°ä½(0, 2...)æ˜¯æ­£æ‹ï¼Œå¥‡æ•°ä½(1, 3...)æ˜¯åæ‹
                    // åæ‹ç¨å¾®å»¶è¿Ÿï¼Œåˆ¶é€  "Ta-ka, Ta-ka" çš„æ„Ÿè§‰
                    // åŸºç¡€é—´éš” 0.12s
                    let noteOffset = i * 0.12; 
                    
                    // å¦‚æœæ˜¯åæ‹ (ç¬¬2ã€4ä¸ªéŸ³)ï¼Œé¢å¤–åŠ ä¸€ç‚¹å»¶è¿Ÿ (Swing Ratio)
                    if (i % 2 !== 0) {
                        noteOffset += 0.04; 
                    }
        
                    // B. Humanize éšæœºå¾®è°ƒ (Â±0.01s)ï¼Œé˜²æ­¢å¤ªåƒæœºå™¨äºº
                    const randomTiming = (Math.random() * 0.02) - 0.01;
                    
                    // C. æœ€ç»ˆè§¦å‘æ—¶é—´
                    const startTime = now + noteOffset + randomTiming;
        
                    // D. åŠ¨æ€éŸ³é‡ (Velocity)
                    // ç¬¬ä¸€æ‹(Bass)é‡ä¸€ç‚¹ï¼Œå…¶ä»–è½»ä¸€ç‚¹ï¼Œéšæœºæ³¢åŠ¨
                    let velocity = (i === 0) ? 1.0 : 0.7; 
                    velocity += (Math.random() * 0.2 - 0.1); 
        
                    // E. æŒç»­æ—¶é—´ (Staccato vs Legato)
                    // ä½éŸ³é•¿ä¸€ç‚¹(Legato)ï¼Œé«˜éŸ³çŸ­ä¿ƒä¸€ç‚¹(Staccato)
                    const duration = (i === 0) ? 0.8 : 0.4;
        
                    // === æ’­æ”¾æ ¸å¿ƒ ===
                    // è¿™é‡Œæˆ‘ä»¬éœ€è¦å¤ç”¨ playTone çš„é€»è¾‘ï¼Œä½†å…è®¸ä¼ å…¥è‡ªå®šä¹‰çš„æ—¶é—´å’ŒéŸ³é‡
                    // ä¸ºäº†ä¸ä¿®æ”¹ playTone å¤ªå¤šï¼Œæˆ‘ä»¬ç›´æ¥åœ¨è¿™é‡Œè°ƒç”¨åº•å±‚é€»è¾‘ï¼Œæˆ–è€…ç»™ playTone åŠ å‚æ•°
                    // å»ºè®®ï¼šç›´æ¥è°ƒç”¨ playToneï¼Œåˆ©ç”¨å®ƒå·²æœ‰çš„æ—¶é—´å‚æ•°ï¼Œä½†æˆ‘ä»¬éœ€è¦å¾®è°ƒ playTone è®©å®ƒæ”¯æŒ volume å‚æ•°
                    // ä¸ºäº†æ–¹ä¾¿ï¼Œè¿™é‡Œæˆ‘æŠŠ playTone çš„æ ¸å¿ƒé€»è¾‘æå–å‡ºæ¥åšä¸€ä¸ªå†…éƒ¨è°ƒç”¨ï¼š
                    
                    this._scheduleNote(n, startTime, duration, velocity);
                });
            },
        
            _scheduleNote(n, t, duration, velocity) {
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();

        osc.type = 'sine'; // ä¿æŒä¸€è‡´ï¼šçº¯æ­£å¼¦
        osc.frequency.value = this.baseFreq * n;

        gain.gain.setValueAtTime(0, t);
        
        // === åŒæ­¥éŸ³é‡é€»è¾‘ ===
        // åŸºç¡€éŸ³é‡æ˜¯ 1/nï¼Œä½†è¦ä¹˜ä»¥çˆµå£«ä¹çš„åŠ›åº¦(velocity)
        const baseVol = 1 / n;
        const finalVol = baseVol * velocity;
        
        gain.gain.linearRampToValueAtTime(finalVol, t + 0.005);

        // === åŒæ­¥æ—¶é•¿é€»è¾‘ ===
        // ä½¿ç”¨åŒæ ·çš„ç‰©ç†è¡°å‡å…¬å¼
        const decayTime = 1.5 / Math.sqrt(n);
        gain.gain.exponentialRampToValueAtTime(0.001, t + decayTime);

        // ç«‹ä½“å£° (ä¿ç•™çˆµå£«çš„ å·¦ä½å³é«˜ åˆ†å¸ƒ)
        const panner = this.ctx.createStereoPanner();
        const panVal = ((n - 1) / 14) - 0.5; 
        panner.pan.value = panVal;

        osc.connect(gain);
        gain.connect(panner);
        panner.connect(this.compressor);

        osc.start(t);
        // åœæ­¢æ—¶é—´å– decayTime å’Œ duration çš„æœ€å¤§å€¼ï¼Œé˜²æ­¢æˆªæ–­
        osc.stop(t + Math.max(decayTime, duration) + 0.1);
    },
        };
        
        // ä¿æŒç‚¹å‡»åˆå§‹åŒ–é€»è¾‘
        document.addEventListener('click', () => {
            AudioSys.init();
            if (AudioSys.ctx && AudioSys.ctx.state === 'suspended') {
                AudioSys.ctx.resume();
            }
        }, { once: true });
        
        // === I18N å­—å…¸ ===
        const i18n = {
            zh: {
                profile_back: "å›åˆ°ä¸»é¡µ",
                profile_role: "çŠ¶æ€ï¼šå·²è¿æ¥",
                lbl_dataset: "ç‰Œåº“è®¾å®š",
                lbl_target: "ç›®æ ‡æ•°å­—",
                
                btn_simple: "ç®€å•",
                btn_classic: "ç»å…¸",
                btn_standard: "æ ‡å‡†",
                
                lbl_timer: "è®¡æ—¶æ¨¡å¼",
                btn_endless: "æ— å°½",
                btn_hourglass: "æ²™æ¼",
                btn_breathing: "å‘¼å¸",
                
                lbl_tolerance: "å®¹é”™æœºä¼š",
                btn_casual: "ä¼‘é—² (3)",
                btn_challenge: "æŒ‘æˆ˜ (1)",
                btn_extreme: "æé™ (0)",
                
                lbl_length: "èµ›ç¨‹é•¿åº¦",
                btn_base: "åŸºç¡€ (1)",
                btn_endurance: "è€ä¹… (10)",
                btn_infinite: "æ— é™ (âˆ)",
                
                btn_start: "å¯åŠ¨ç³»ç»Ÿ",
                stat_rnd: "è½®æ¬¡:",
                stat_deck: "ç‰Œå †:",
                stat_time: "æ—¶é—´:",
                stat_chances: "æœºä¼š:",
                btn_hint: "æç¤º",
                btn_restart: "é‡å¼€",
                btn_menu: "èœå•",
                msg_ready: "ç³»ç»Ÿå°±ç»ª",
                btn_clear: "å–æ¶ˆ",
                btn_all: "æ‰§è¡Œå…¨éƒ¨",
                btn_draw: "æŠ½ç‰Œ",
                btn_max: "å·²æ»¡",
                btn_empty: "è€—å°½",
                btn_exec: "æ‰§è¡Œ",
                btn_select: "é€‰æ‹© (2-4)",
                btn_full: "å·²æ»¡",
                footer: "åˆ¶ä½œ: 2025 // ä½œè€…: ç‚¹ç¼€æ˜Ÿç©º",
                fail_title: "è¡ŒåŠ¨å¤±è´¥",
                success_title: "è¡ŒåŠ¨æˆåŠŸ",
                run_ended_title: "è¡ŒåŠ¨ç»“æŸ",
                legendary_title: "ä¼ å¥‡",
                msg_signal_lost: "ä¿¡å·ä¸¢å¤±",
                msg_time_exhausted: "æ—¶é—´è€—å°½",
                msg_timeout: "è¶…æ—¶",
                msg_dead_end: "æ­»å±€",
                msg_no_solution: "æ— è§£",
                msg_calc_valid: "è®¡ç®—æœ‰æ•ˆ",
                msg_next_phase: "è¿›å…¥ä¸‹ä¸€é˜¶æ®µ...",
                msg_wave_cleared: "æ³¢æ¬¡å®Œæˆ...",
                msg_mission_complete: "ä»»åŠ¡å®Œæˆ",
                msg_db_not_ready: "æ•°æ®æœªå°±ç»ª",
                msg_loading: "æ•°æ®åŠ è½½ä¸­...",
                msg_db_fail: "æ•°æ®åŠ è½½å¤±è´¥",
                msg_no_moves: "æ— è·¯å¯èµ° - è¯·æŠ½ç‰Œ",
                msg_hint_all: "å®Œç¾æ‰‹ç‰Œ - æ‰§è¡Œå…¨éƒ¨",
                msg_deadlock: "æ­»å±€ / æ•°æ®åº“å»¶è¿Ÿ",
                msg_legendary_sub: "å‘ç°æ— è§£ç‰Œç»„",
                btn_review: "å¤ç›˜",
                btn_retry: "é‡è¯•",
                btn_close: "å…³é—­",
                lbl_sol_data: "è§£æ³•æ•°æ®",
                lbl_no_records: "æš‚æ— è®°å½•",
                lbl_remaining: "å‰©ä½™æ‰‹ç‰Œ",
                lbl_no_solution: "æ— è§£",
                rec_new: "æ–°çºªå½•ï¼",
                rec_best: "æœ€ä½³çºªå½•:",
                rec_none: "æš‚æ— çºªå½•",
                rec_invalid: "çºªå½•æ— æ•ˆ (ä½¿ç”¨æç¤º)",
                rec_unaffected: "çºªå½•ä¸å—å½±å“",
                rec_time_prefix: "æ€»ç”¨æ—¶: ",
                rec_round_prefix: "å®Œæˆè½®æ¬¡: ",
                mode_clears: "é€šå…³æ¬¡æ•°:",
                theme_dark: "ç‚¹ç¼€",
                theme_light: "æ˜Ÿç©º",
                lang_btn: "English",
                
                btn_help: "æŒ‡å—",
                btn_close_rules: "å…³é—­æŒ‡å—",
                btn_details: "è¯¦ç»†æ­¥éª¤"
            },
            en: {
                profile_back: "HOME",
                profile_role: "STATUS: LINKED",
                
                lbl_target: "TARGET",
                
                lbl_dataset: "DECK",
                btn_simple: "SIMPLE",
                btn_classic: "CLASSIC",
                btn_standard: "STANDARD",
                
                lbl_timer: "TIMER",
                btn_endless: "ENDLESS",
                btn_hourglass: "HOURGLASS",
                btn_breathing: "BREATHING",
                
                lbl_tolerance: "TOLERANCE",
                btn_casual: "CASUAL (3)",
                btn_challenge: "STRICT (1)",
                btn_extreme: "EXTREME (0)",
                
                lbl_length: "LENGTH",
                btn_base: "BASE (1)",
                btn_endurance: "STAMINA (10)",
                btn_infinite: "INFINITE (âˆ)",
                
                btn_start: "INITIATE",
                stat_rnd: "RND:",
                stat_deck: "PILE:",
                stat_time: "TIME:",
                stat_chances: "CHANCES:",
                btn_hint: "HINT",
                btn_restart: "RESTART",
                btn_menu: "MENU",
                msg_ready: "SYSTEM READY",
                btn_clear: "CLEAR",
                btn_all: "EXEC ALL",
                btn_draw: "DRAW",
                btn_max: "MAX",
                btn_empty: "EMPTY",
                btn_exec: "EXECUTE",
                btn_select: "SELECT (2-4)",
                btn_full: "FULL",
                footer: "BUILD: 2025 // CREATOR: ç‚¹ç¼€æ˜Ÿç©º (Stellate)",
                fail_title: "FAIL",
                success_title: "SUCCESS",
                run_ended_title: "RUN ENDED",
                legendary_title: "LEGENDARY",
                msg_signal_lost: "SIGNAL LOST",
                msg_time_exhausted: "TIME EXHAUSTED",
                msg_timeout: "TIMEOUT",
                msg_dead_end: "DEAD END",
                msg_no_solution: "NO SOLUTION",
                msg_calc_valid: "CALCULATION VALID",
                msg_next_phase: "NEXT PHASE...",
                msg_wave_cleared: "WAVE CLEARED...",
                msg_mission_complete: "MISSION COMPLETE",
                msg_db_not_ready: "DB NOT READY",
                msg_loading: "LOADING DATA...",
                msg_db_fail: "DB LOAD FAIL",
                msg_no_moves: "NO MOVES - DRAW CARD",
                msg_hint_all: "PERFECT HAND - EXEC ALL",
                msg_deadlock: "DEAD END / DB LAG",
                msg_legendary_sub: "UNSOLVABLE HAND DETECTED",
                btn_review: "REVIEW",
                btn_retry: "RETRY",
                btn_close: "CLOSE",
                lbl_sol_data: "SOLUTION DATA",
                lbl_no_records: "NO RECORDS",
                lbl_remaining: "REMAINING",
                lbl_no_solution: "NO SOLUTION",
                rec_new: "NEW RECORD!",
                rec_best: "BEST RECORD:",
                rec_none: "NO RECORD",
                rec_invalid: "RECORD INVALID (ASSISTED)",
                rec_unaffected: "RECORD UNAFFECTED",
                rec_time_prefix: "TOTAL TIME: ",
                rec_round_prefix: "ROUNDS CLEARED: ",
                mode_clears: "MODE CLEARS:",
                theme_dark: "CYBER",
                theme_light: "CUTE",
                lang_btn: "ä¸­æ–‡",

                btn_help: "HELP",
                btn_close_rules: "CLOSE MANUAL",
                btn_details: "DETAILS"
            }
        };

        // --- æ ¸å¿ƒçŠ¶æ€ ---
        const cfg = { target: 24, deck:'standard', time:'endless', life:'challenge', rounds: 1 };
        const state = {
            deck: [], hand: [], selection: [], history: [],
            chances: 0, timer: 0, interval: null, breath: 10.0,
            active: false, totalTime: 0,
            currentRound: 1, maxRounds: 1,
            hintUsed: false,
            lastTick: 0,
            lastRender: 0,
            animTimers: [],
            barEl: null,
            lang: localStorage.getItem('p24_lang') || 'zh' // é»˜è®¤è¯­è¨€
        };

        // === ç»“ç®—ç•Œé¢ çˆµå£«ç¼–æ›²å™¨ (æ— é™å¾ªç¯ç‰ˆ) ===
        const ResultSequencer = {
            timer: null,
            sequence: [],    // å­˜å‚¨è¿™ä¸€å±€çš„å®Œæ•´ä¹è°±
            currentIndex: 0, // å½“å‰æ’­æ”¾åˆ°äº†ç¬¬å‡ å°èŠ‚
            isPlaying: false,
        
            // å¼€å§‹æ¼”å¥
            start(history) {
                this.stop(); // å…ˆé‡ç½®
        
                // 1. æå–æ‰€æœ‰æˆåŠŸçš„ç‰Œç»„ï¼Œç”Ÿæˆä¹è°±
                this.sequence = history
                    .filter(h => h.status === 'success')
                    .map(h => h.cards);
        
                // å¦‚æœä¸€å±€éƒ½æ²¡èµ¢ï¼Œå°±ä¸æ’­äº†
                if (this.sequence.length === 0) return;
        
                this.isPlaying = true;
                this.currentIndex = 0;
                
                // å¼€å§‹æ’­æ”¾ç¬¬ä¸€èŠ‚
                this.next();
            },
        
            // åœæ­¢æ¼”å¥
            stop() {
                this.isPlaying = false;
                clearTimeout(this.timer);
                this.sequence = [];
                this.currentIndex = 0;
            },
        
            // è°ƒåº¦ä¸‹ä¸€èŠ‚
            next() {
                if (!this.isPlaying || this.sequence.length === 0) return;
        
                // 1. è·å–å½“å‰æŒ‡é’ˆæŒ‡å‘çš„ç‰Œç»„
                const cards = this.sequence[this.currentIndex];
        
                // 2. æ¼”å¥ (å¸¦å®¹é”™æ£€æµ‹)
                if (AudioSys && typeof AudioSys.playJazzArpeggio === 'function') {
                    AudioSys.playJazzArpeggio(cards);
                }
        
                // 3. æŒ‡é’ˆç§»åŠ¨ï¼šå®ç°æ— é™å¾ªç¯çš„æ ¸å¿ƒ
                // (å½“å‰ + 1) % æ€»é•¿åº¦ -> è¿™æ ·åˆ°äº†æœ«å°¾ä¼šè‡ªåŠ¨å›åˆ° 0
                this.currentIndex = (this.currentIndex + 1) % this.sequence.length;
        
                // 4. è®¡ç®—å‘¼å¸é—´éš”
                let delay = 700 + Math.random() * 300; // åŸºç¡€é—´éš” 0.7s ~ 1.0s
        
                // === ç»†èŠ‚ä¼˜åŒ–ï¼šå¾ªç¯åˆ†æ®µ ===
                // å¦‚æœæŒ‡é’ˆå›åˆ°äº† 0ï¼Œè¯´æ˜åˆšæ’­å®Œä¸€æ•´è½®
                // æˆ‘ä»¬åŠ ä¸€ä¸ªè¾ƒé•¿çš„åœé¡¿ (2ç§’)ï¼Œè®©å¬æ„Ÿåƒæ˜¯ä¸€ä¸ªâ€œä¹æ®µâ€ç»“æŸäº†ï¼Œä¼‘æ¯ä¸€ä¸‹å†å¼€å§‹
                if (this.currentIndex === 0) {
                    delay += 500; 
                }
        
                // 5. é€’å½’è°ƒç”¨
                this.timer = setTimeout(() => {
                    this.next();
                }, delay);
            }
        };

        const solutionDB = new Map();
        let isDbReady = false;
        const $ = (id) => document.getElementById(id);
        
        // --- è¯­è¨€è®¾ç½®å‡½æ•° ---
        function setLang(lang) {
            state.lang = lang;
            localStorage.setItem('p24_lang', lang);
            document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en';

            // 1. é™æ€æ–‡æœ¬æ›¿æ¢
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[lang][key]) {
                    el.innerText = i18n[lang][key];
                }
            });

            // 2. åŠ¨æ€æ›´æ–°æŒ‰é’®çŠ¶æ€ (EXECUTE, DRAWç­‰)
            updateButtonStates();
            updateDrawBtn();
            
            // 3. æ›´æ–°ä¸»é¢˜æŒ‰é’®æ–‡æœ¬ (å› ä¸ºå®ƒæ—¢å—ä¸»é¢˜å½±å“ä¹Ÿå—è¯­è¨€å½±å“)
            updateThemeBtnText();

            updateSoundBtn();
        }

        function toggleLanguage() {
            setLang(state.lang === 'zh' ? 'en' : 'zh');
        }
        
        // Helper: è·å–ç¿»è¯‘
        const t = (key) => i18n[state.lang][key] || key;

        // å®šä¹‰ç»„çš„é¡ºåºï¼Œç”¨äºè®¡ç®—éŸ³é«˜åç§» (æ¯ç»„3ä¸ªéŸ³)
        const groupOrder = ['opt-target', 'opt-deck', 'opt-time', 'opt-life', 'opt-rounds'];
        
        // Setup
        document.querySelectorAll('.btn-group button').forEach(b => {
            b.onclick = (e) => {
                const btn = e.target;
                const p = e.target.parentElement;
                p.querySelectorAll('button').forEach(x => x.classList.remove('active'));
                e.target.classList.add('active');

                if(p.id === 'opt-target') {
                    const newTarget = parseInt(e.target.dataset.val);
                    if(cfg.target !== newTarget) {
                        cfg.target = newTarget;
                        updateAppIdentity(); // æ›´æ–°æ ‡é¢˜å’ŒUI
                        loadData();          // é‡æ–°åŠ è½½å¯¹åº”çš„æ•°æ®åº“
                    }
                }
                
                if(p.id==='opt-deck') cfg.deck = e.target.dataset.val;
                if(p.id==='opt-time') cfg.time = e.target.dataset.val;
                if(p.id==='opt-life') cfg.life = e.target.dataset.val;
                if(p.id==='opt-rounds') cfg.rounds = parseInt(e.target.dataset.val);

                localStorage.setItem('p24_last_config', JSON.stringify(cfg));

                const groupIndex = groupOrder.indexOf(p.id);
                if (groupIndex !== -1) {
                    // æ‰¾åˆ°æŒ‰é’®åœ¨ç»„å†…çš„ç´¢å¼• (0-2)
                    const btnIndex = Array.from(p.children).indexOf(btn);
                    // è®¡ç®—éŸ³é«˜: ç»„ç´¢å¼•*3 + æŒ‰é’®ç´¢å¼• + 1
                    // ä¾‹å¦‚: opt-target(0)*3 + ç¬¬ä¸€ä¸ªæŒ‰é’®(0) + 1 = éŸ³é«˜ 1
                    // ä¾‹å¦‚: opt-rounds(4)*3 + æœ€åä¸€ä¸ªæŒ‰é’®(2) + 1 = éŸ³é«˜ 15
                    const toneNum = (groupIndex * 3) + btnIndex + 1;
                    
                    // æ’­æ”¾å¯¹åº”éŸ³ç¬¦
                    AudioSys.playTone(toneNum, 0.4); 
                }
            }
        });

        $('start-btn').onclick = startGame;
        
        $('btn-draw').onclick = () => { drawCards(1); };
        $('btn-exec').onclick = execCards;

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function fmtTime(s) {
            let m = Math.floor(s/60);
            let sec = Math.floor(s%60);
            return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        }

        function fmtTimePrecise(s) {
            let m = Math.floor(s / 60);
            let sec = Math.floor(s % 60);
            let ms = Math.floor((s % 1) * 1000); 
            return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}.${ms.toString().padStart(3,'0')}`;
        }

        // ä¿®æ”¹ï¼šsetStatus ç°åœ¨æ¥æ”¶ key
        function setStatus(key, color) {
            const el = $('msg-display');
            // å°è¯•ç¿»è¯‘ï¼Œå¦‚æœ key æ²¡åœ¨å­—å…¸é‡Œï¼Œå°±ç›´æ¥æ˜¾ç¤º key
            el.innerText = t(key);
            el.style.color = color;
            // è®°å½•å½“å‰çŠ¶æ€ key ä»¥ä¾¿åˆ‡æ¢è¯­è¨€æ—¶åˆ·æ–°ï¼Ÿ
            // ç®€å•èµ·è§ï¼Œè¿™é‡Œå‡è®¾æ¯æ¬¡ setStatus éƒ½æ˜¯å³æ—¶æ“ä½œã€‚
            // å¦‚æœè¦å®Œç¾æ”¯æŒè¯­è¨€åˆ‡æ¢æ—¶çš„çŠ¶æ€ä¿ç•™ï¼Œéœ€è¦ä¿å­˜ currentStatusKeyã€‚
            el.setAttribute('data-current-key', key);
        }
        
        // ä¿®æ­£ï¼šç›‘å¬è¯­è¨€åˆ‡æ¢åˆ·æ–°çŠ¶æ€æ 
        const originalSetLang = setLang;
        setLang = function(lang) {
            originalSetLang(lang);
            const msgEl = $('msg-display');
            const currentKey = msgEl.getAttribute('data-current-key');
            if (currentKey) {
                 msgEl.innerText = t(currentKey);
            }
        }

        function startGame() {
            ResultSequencer.stop();

            if (!AudioSys.muted) {
                const currentTones = [];
                const groupOrder = ['opt-target', 'opt-deck', 'opt-time', 'opt-life', 'opt-rounds'];
                
                groupOrder.forEach((gid, gIndex) => {
                    const group = $(gid);
                    if (group) {
                        const activeBtn = group.querySelector('.active');
                        if (activeBtn) {
                            const btnIndex = Array.from(group.children).indexOf(activeBtn);
                            // è®¡ç®—éŸ³é«˜: 1-15
                            const tone = (gIndex * 3) + btnIndex + 1;
                            currentTones.push(tone);
                        }
                    }
                });

                if (currentTones.length > 0) {
                    // ç¨å¾®å»¶è¿Ÿ 100ms æ’­æ”¾ï¼Œé¿å¼€æŒ‰é’®ç‚¹å‡»éŸ³ï¼Œå¬èµ·æ¥æ›´æ¸…æ™°
                    setTimeout(() => {
                        AudioSys.playChord(currentTones);
                    }, 100);
                }
            }
            
            $('start-screen').style.display = 'none';
            $('game-over').style.display = 'none';
            $('review-ui').style.display = 'none';
            $('game-ui').style.display = 'flex';

            state.barEl = $('timer-bar');

            state.active = true;
            state.totalTime = 0; 
            state.history = [];
            state.hintUsed = false;
            state.lastTick = Date.now();
            
            state.maxRounds = cfg.rounds;
            state.currentRound = 1;

            if (state.maxRounds > 1) {
                $('round-display').style.display = 'flex';
            } else {
                $('round-display').style.display = 'none';
            }

            if(cfg.life === 'casual') state.chances = 3;
            else if(cfg.life === 'challenge') state.chances = 1;
            else state.chances = 0; // Extreme
            updateStats();
            
            clearInterval(state.interval);
            state.interval = setInterval(tick, 16);

            startRound();
        }

        function startRound() {
            state.hand = [];
            state.selection = [];
            $('card-container').innerHTML = '';

            if (cfg.rounds === -1) {
                $('round-val').innerText = state.currentRound;
                $('round-display').style.display = 'flex';
            } else if (state.maxRounds > 1) {
                $('round-val').innerText = `${state.currentRound}/${state.maxRounds}`;
                $('round-display').style.display = 'flex';
            } else {
                $('round-display').style.display = 'none';
            }

            const timerBar = $('timer-bar');
            const progressArea = document.querySelector('.progress-area');
            timerBar.style.backgroundColor = 'var(--primary-color)';
            if (cfg.time === 'endless') {
                timerBar.style.width = '0%';
                progressArea.style.visibility = 'hidden';
            } else {
                progressArea.style.visibility = 'visible';
                timerBar.style.width = '100%'; 
            }

            let pool = [];
            if (cfg.deck === 'simple') {
                const highProb = [3, 4, 6, 12]; 
                for (let i = 1; i <= 13; i++) {
                    let count = highProb.includes(i) ? 8 : 4;
                    for (let k = 0; k < count; k++) pool.push(i);
                }
            } else if (cfg.deck === 'classic') {
                for (let i = 1; i <= 13; i++) {
                    for (let k = 0; k < 4; k++) pool.push(i);
                }
            } else { 
                for (let i = 1; i <= 13; i++) {
                    for (let k = 0; k < 4; k++) pool.push(i);
                }
                pool.push(14, 15);
            }
            state.deck = pool;
            shuffleArray(state.deck);
            
            $('deck-val').innerText = state.deck.length; 

            if(cfg.time === 'hourglass') state.timer = 60.0;
            else if(cfg.time === 'breathing') state.breath = 10.0;
            else state.timer = 0; 

            drawCards(10);
            
            setStatus("msg_ready", "var(--secondary-color)");
            state.active = true;
        }

        function tick() {
            if(!state.active) {
                state.lastTick = Date.now();
                return;
            }

            let now = Date.now();
            let dt = (now - state.lastTick) / 1000;
            state.lastTick = now;
            state.totalTime += dt;

            if(cfg.time === 'endless') {
                state.timer += dt;
            } else if(cfg.time === 'hourglass') {
                state.timer -= dt;
                if(state.timer <= 0) { gameOver("msg_time_exhausted", false); return; }
            } else if(cfg.time === 'breathing') {
                state.breath -= dt;
                if(state.breath <= 0) {
                    fail("msg_timeout");
                    state.breath = 10.0;
                }
            }

            if (now - state.lastRender > 100) {
                state.lastRender = now;

                if(cfg.time === 'endless') {
                    $('time-val').innerText = fmtTime(state.timer);
                }
                else if(cfg.time === 'hourglass') {
                    $('time-val').innerText = Math.max(0, state.timer).toFixed(1);
                    let pct = (state.timer / 60) * 100;
                    $('timer-bar').style.width = pct + "%";
                }
                else if(cfg.time === 'breathing') {
                    let pct = (state.breath / 10.0) * 100;
                    $('timer-bar').style.width = pct + "%";
                    $('time-val').innerText = state.breath.toFixed(1);
                    
                    if(state.breath <= 3) $('timer-bar').style.backgroundColor = 'var(--alert-color)';
                    else $('timer-bar').style.backgroundColor = 'var(--primary-color)';
                }
            }
        }

        function drawCards(n) {
            if(state.hand.length >= 10) return;

            $('btn-draw').classList.remove('suggest');
            $('btn-all').classList.remove('suggest');
            setStatus("msg_ready", "var(--secondary-color)");

            for(let i=0; i<n; i++) {
                if(state.deck.length === 0) break;
                if(state.hand.length >= 10) break;
                let val = state.deck.pop();
                state.hand.push({ id: Math.random(), val: val, isNew: true });
            }
            
            sortHand();
            render(); 
            
            state.hand.forEach(c => c.isNew = false);

            if (isDbReady) {
                if (state.hand.length === 10) {
                    if (!checkSolvability(state.hand)) {
                        const miracleHand = state.hand.map(c => c.val).join(', ');
                        setTimeout(() => {
                            gameOver(miracleHand, true, true); 
                        }, 1000);
                        return;
                    }
                }

                if (state.deck.length === 0 && state.hand.length > 0) {
                    if (!checkSolvability(state.hand)) {
                        fail("msg_dead_end");
                    }
                }
            }
        }

        function sortHand() {
            state.hand.sort((a,b) => a.val - b.val);
        }

        function updateButtonStates() {
            let sc = state.selection.length;
            let handLen = state.hand.length;
            
            // 1. Execute æŒ‰é’®
            let btnExec = $('btn-exec');
            let canExec = (sc >= 2 && sc <= 4);
            
            if(canExec) {
                btnExec.disabled = false;
                btnExec.classList.add('ready');
                btnExec.innerHTML = `<span class="key-hint">â†µ</span>` + t('btn_exec'); 
            } else {
                btnExec.disabled = true;
                btnExec.classList.remove('ready');
                let txtKey = sc < 2 ? 'btn_select' : 'btn_full';
                btnExec.innerHTML = `<span class="key-hint">â†µ</span>` + t(txtKey);
            }

            // 2. All In æŒ‰é’®
            let btnAll = $('btn-all');
            let showAllIn = (handLen >= 2 && handLen <= 4);
            
            if (showAllIn) {
                btnAll.style.display = 'block';
                // ä»…æ›´æ–°æ–‡æœ¬éƒ¨åˆ†ï¼Œä¿ç•™ key-hint
                // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦é‡æ–°æ„å»º innerHTML
                btnAll.innerHTML = `<span class="key-hint">â†µ</span>` + t('btn_all');
            } else {
                btnAll.style.display = 'none';
            }

            // 3. Clear æŒ‰é’®
            let btnClear = $('btn-clear');
            if (sc >= 2) {
                btnClear.style.display = 'block';
                btnClear.innerHTML = `<span class="key-hint">ESC</span>` + t('btn_clear');
            } else {
                btnClear.style.display = 'none';
            }

            // --- åŠ¨æ€æ§åˆ¶ Enter æç¤ºæ˜¾éš ---
            const hintExec = btnExec.querySelector('.key-hint');
            const hintAll = btnAll.querySelector('.key-hint');

            if (canExec) {
                if(hintExec) hintExec.classList.remove('hint-hide');
                if(hintAll) hintAll.classList.add('hint-hide'); 
            } else {
                if(hintExec) hintExec.classList.add('hint-hide');
                if (showAllIn) {
                    if(hintAll) hintAll.classList.remove('hint-hide');
                }
            }
        }

        function updateCardVisual(id) {
            const cardDiv = document.querySelector(`.card[data-id="${id}"]`);
            if (!cardDiv) return;
            const isSelected = state.selection.includes(id);
            
            if (isSelected) {
                cardDiv.classList.remove('card-hidden'); 
                cardDiv.classList.add('selected');
            } else {
                cardDiv.classList.remove('selected');
            }
        }

        function setCardSelection(id, shouldSelect) {
            const idx = state.selection.indexOf(id);
            if (shouldSelect) {
                if (idx === -1) {
                    const cardObj = state.hand.find(c => c.id === id);
                    if (cardObj) {
                        // æ’­æ”¾å•éŸ³
                        AudioSys.playTone(cardObj.val, 0.6); 
                    }
                    
                    if (state.selection.length >= 4) {
                        const firstId = state.selection.shift(); 
                        updateCardVisual(firstId); 
                    }
                    state.selection.push(id);
                    updateCardVisual(id);
                    updateButtonStates();
                }
            } else {
                if (idx > -1) {
                    state.selection.splice(idx, 1);
                    updateCardVisual(id);
                    updateButtonStates();
                }
            }
        }

        function toggleSelect(id) {
            const idx = state.selection.indexOf(id);

            // æ‰¾åˆ°è¿™å¼ ç‰Œå¯¹åº”çš„æ•°å­—å€¼
            const cardObj = state.hand.find(c => c.id === id);
            
            // === æ–°å¢ï¼šæ’­æ”¾å¯¹åº”çš„æ³›éŸ³ ===
            if (cardObj) {
                // å¦‚æœæ˜¯â€œé€‰ä¸­â€åŠ¨ä½œï¼Œæ’­æ”¾å£°éŸ³
                // å¦‚æœæ˜¯â€œå–æ¶ˆé€‰ä¸­â€ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©æ’­æ”¾ä¸€ä¸ªçŸ­ä¿ƒçš„ä½éŸ³ï¼Œæˆ–è€…ä¸æ’­
                const idx = state.selection.indexOf(id);
                if (idx === -1) { // æ­¤æ—¶è¿˜æ²¡pushè¿›å»ï¼Œè¯´æ˜å³å°†è¢«é€‰ä¸­
                    AudioSys.playTone(cardObj.val, 0.6); // æ’­æ”¾ 0.6ç§’
                }
            }
            
            setCardSelection(id, idx === -1);
        }

        function render() {
            const container = $('card-container');
            const existingNodes = new Map();
            Array.from(container.children).forEach(el => {
                if(el.dataset.id) existingNodes.set(parseFloat(el.dataset.id), el);
            });

            let newCardCounter = 0; 
            state.hand.forEach((c, index) => {
                let div = existingNodes.get(c.id);

                if (!div) {
                    div = document.createElement('div');
                    div.dataset.id = c.id;
                    div.onclick = () => toggleSelect(c.id);
                    div.className = 'card';
                    
                    if (c.isNew) {
                        div.classList.add('card-hidden');
                        void div.offsetWidth; 
                        let delay = 16 + newCardCounter * 40;
                        newCardCounter++; 
                        setTimeout(() => {
                            div.classList.remove('card-hidden');
                        }, delay);
                    }
                }

                let keyLabel = (index + 1) % 10; 
                div.innerHTML = `<span class="key-hint">${keyLabel}</span>${c.val}`;

                container.appendChild(div);

                const isSelected = state.selection.includes(c.id);
                if (isSelected && !div.classList.contains('selected')) {
                    div.classList.remove('card-hidden');
                    div.classList.add('selected');
                } else if (!isSelected && div.classList.contains('selected')) {
                    div.classList.remove('selected');
                }

                existingNodes.delete(c.id);
            });

            existingNodes.forEach(el => el.remove());

            $('deck-val').innerText = state.deck.length;
            updateDrawBtn();
            updateButtonStates();
        }

        function updateDrawBtn() {
            let btn = $('btn-draw');
            let hintHtml = `<span class="key-hint">Q</span>`;
            let txtKey = 'btn_draw';

            if(state.hand.length >= 10) { 
                btn.disabled = true; 
                txtKey = 'btn_max';
            } else if(state.deck.length === 0) { 
                btn.disabled = true; 
                txtKey = 'btn_empty';
            } else { 
                btn.disabled = false; 
            }
            btn.innerHTML = hintHtml + t(txtKey);
        }

        // --- Touch ---
        let isSwiping = false;
        let swipeTargetState = true; 
        let touchedCardsInGesture = new Set(); 
        const container = $('card-container');

        container.addEventListener('touchstart', (e) => {
            if(e.cancelable) e.preventDefault();
            isSwiping = true; touchedCardsInGesture.clear();
            handleSwipe(e);
        }, { passive: false });

        container.addEventListener('touchmove', (e) => {
            if (!isSwiping) return;
            if(e.cancelable) e.preventDefault();
            handleSwipe(e);
        }, { passive: false });

        container.addEventListener('touchend', () => { isSwiping = false; touchedCardsInGesture.clear(); });
        container.addEventListener('touchcancel', () => { isSwiping = false; touchedCardsInGesture.clear(); });

        function handleSwipe(e) {
            const touch = e.touches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            if (!target) return;
            const cardDiv = target.closest('.card');
            if (cardDiv) {
                const cardId = parseFloat(cardDiv.dataset.id);
                if (isNaN(cardId)) return;
                if (touchedCardsInGesture.size === 0) {
                    const isSelected = state.selection.includes(cardId);
                    swipeTargetState = !isSelected;
                }
                if (!touchedCardsInGesture.has(cardId)) {
                    touchedCardsInGesture.add(cardId);
                    setCardSelection(cardId, swipeTargetState);
                }
            }
        }

        function selectAllAndExec() {
            state.selection = state.hand.map(c => c.id);
            state.selection.forEach(id => updateCardVisual(id));
            updateButtonStates();
            setTimeout(() => { execCards(); }, 150);
        }

        function clearSelection() {
            state.selection.forEach(id => {
                const cardDiv = document.querySelector(`.card[data-id="${id}"]`);
                if(cardDiv) cardDiv.classList.remove('selected');
            });
            state.selection = [];
            updateButtonStates();
        }

        function checkSolvability(hand) {
            if (!isDbReady) return true; 
            
            const indices = hand.map((_, i) => i);
            const trySizes = [4, 3, 2]; 

            for (let r of trySizes) {
                let combos = getCombinations(indices, r);
                for (let comboIndices of combos) {
                    let values = comboIndices.map(i => hand[i].val).sort((a, b) => a - b);
                    if (solutionDB.has(values.join(','))) {
                        return true; 
                    }
                }
            }
            return false;
        }

        // === æ’­æ”¾æµ®ç©ºæ–‡æœ¬åŠ¨ç”» ===
        function showFloatingText(text) {
            // åˆ›å»ºå…ƒç´ 
            const el = document.createElement('div');
            el.className = 'float-equation';
            el.innerText = text;
            
            // æŒ‚è½½åˆ° body
            document.body.appendChild(el);
            
            // åŠ¨ç”»ç»“æŸåè‡ªåŠ¨é”€æ¯ DOMï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
            el.addEventListener('animationend', () => {
                el.remove();
            });
        }
        
        function execCards() {
            if(state.selection.length < 2 || state.selection.length > 4) return;
            if(!isDbReady) { setStatus("msg_db_not_ready", "var(--alert-color)"); return; }

            let selectedCards = state.hand.filter(c => state.selection.includes(c.id));
            let values = selectedCards.map(c => c.val);
            values.sort((a, b) => a - b);
            const key = values.join(',');
            const resultLine = solutionDB.get(key);
            
            if(resultLine) {
                setStatus("msg_calc_valid", "var(--success-color)");
                
                if(cfg.time === 'breathing') state.breath = 10.0;

                AudioSys.playChord(values);

                showFloatingText(resultLine);
                
                state.history.push({ cards: selectedCards.map(c=>c.val), sol: resultLine, status: 'success' });

                state.hand = state.hand.filter(c => !state.selection.includes(c.id));
                state.selection = [];
                render(); 

                if(state.active && state.hand.length === 0) {
                    state.active = false; 
                    
                    if (state.barEl) {
                        state.barEl.style.transform = 'scaleX(1)';
                        if(cfg.time === 'breathing') state.barEl.style.backgroundColor = 'var(--primary-color)';
                    }

                    if (cfg.rounds === -1 || state.currentRound < state.maxRounds) {
                        state.currentRound++;
                        let msgKey = cfg.rounds === -1 ? "msg_wave_cleared" : "msg_next_phase";
                        setStatus(msgKey, "var(--primary-color)");
                        setTimeout(() => {
                            startRound(); 
                        }, 100); 
                    } else {
                        setTimeout(() => gameOver("msg_mission_complete", true), 100);
                    }
                } else if (state.active && state.hand.length > 0) {
                    if (state.deck.length === 0) {
                        if (!checkSolvability(state.hand)) {
                            fail("msg_dead_end"); 
                        } else {
                            setTimeout(() => { setStatus("msg_ready", "var(--secondary-color)"); }, 800);
                        }
                    } else {
                        setTimeout(() => { setStatus("msg_ready", "var(--secondary-color)"); }, 800);
                    }
                }

            } else {
                state.history.push({ cards: selectedCards.map(c=>c.val), sol: null, status: 'fail' });
                fail("msg_no_solution"); 

                if (state.active) {
                    if(cfg.time === 'breathing') state.breath = 10.0;
                    clearSelection();
                }
            }
        }

        function fail(reasonKey) {
            if (AudioSys && typeof AudioSys.playError === 'function') {
                AudioSys.playError();
            }
            
            state.chances--;
            updateStats();
            
            const win = $('main-window');
            win.classList.remove('anim-shake');
            void win.offsetWidth; 
            win.classList.add('anim-shake');
            setTimeout(() => {
                win.classList.remove('anim-shake');
            }, 210); 

            if(state.chances < 0) gameOver(reasonKey, false);
        }

        function updateStats() {
            let disp = state.chances < 0 ? 0 : state.chances;
            $('chance-val').innerText = disp;
        }

        function getPrefix() {
            return `p${cfg.target}`; // è¿”å› p24, p36, æˆ– p60
        }
        
        function getRecordKey() {
            return `${getPrefix()}_record_${cfg.deck}_${cfg.time}_${cfg.life}_${cfg.rounds}`;
        }
        
        function gameOver(msgKeyOrRaw, win, isMiracle = false) {
            state.active = false;
            clearInterval(state.interval);

            if (state.hand.length > 0) {
                state.history.push({ 
                    cards: state.hand.map(c => c.val), 
                    sol: null, 
                    status: 'remaining' 
                });
            }
            
            $('game-over').style.display = 'flex';
            const title = $('end-title');
            const msgEl = $('end-msg');
            const recordEl = $('end-record');
            const timeEl = $('end-time');
            
            let survivalScore = 0;
            if (cfg.rounds === -1) {
                survivalScore = Math.max(0, state.currentRound - 1);
            }

            if (isMiracle) {
                title.innerText = t('legendary_title'); 
                title.style.color = "#FFD700"; 
                title.style.textShadow = "0 0 20px #FFD700, 0 0 40px #FF4500";
                msgEl.innerHTML = `<span style="font-size:0.8rem; color:#aaa; display:block; margin-bottom:5px;">${t('msg_legendary_sub')}</span><span style="color:#fff; font-size:1.2rem; font-family:monospace">[ ${msgKeyOrRaw} ]</span>`;
            } 
            else {
                title.style.color = ""; 
                title.style.textShadow = "";
                // æ­¤æ—¶ msgKeyOrRaw åº”è¯¥æ˜¯ key
                msgEl.innerText = t(msgKeyOrRaw);

                if (cfg.rounds === -1) {
                    if (survivalScore > 0) {
                        title.innerText = t('run_ended_title');
                        title.className = "title-success";
                    } else {
                        title.innerText = t('fail_title');
                        title.className = "title-failure";
                    }
                } else {
                    title.innerText = win ? t('success_title') : t('fail_title');
                    title.className = win ? "title-success" : "title-failure";
                }
            }

            if (cfg.rounds === -1) {
                timeEl.innerText = t('rec_round_prefix') + survivalScore;
                timeEl.style.color = "var(--primary-color)";
            } else {
                timeEl.innerText = t('rec_time_prefix') + fmtTimePrecise(state.totalTime);
            }

            const key = getRecordKey();
            const lastRecord = localStorage.getItem(key);
            let bestVal = lastRecord ? parseFloat(lastRecord) : null;

            if (state.hintUsed) {
                recordEl.innerText = t('rec_invalid');
                recordEl.style.color = "var(--alert-color)";
                recordEl.style.animation = "none";
            }
            else if (cfg.rounds === -1) {
                if (survivalScore > 0) {
                    if (bestVal === null || survivalScore > bestVal) {
                        localStorage.setItem(key, survivalScore);
                        recordEl.innerText = t('rec_new');
                        recordEl.style.color = "var(--success-color)";
                        recordEl.style.animation = "pulse 1s infinite";
                    } else {
                        recordEl.innerText = `${t('rec_best')} ${bestVal}`;
                        recordEl.style.color = "#888"; 
                        recordEl.style.animation = "none";
                    }
                } 
                else {
                    if (bestVal !== null) {
                        recordEl.innerText = `${t('rec_best')} ${bestVal}`;
                    } else {
                        recordEl.innerText = t('rec_none');
                    }
                    recordEl.style.color = "#666";
                    recordEl.style.animation = "none";
                }
            }
            else if (isMiracle) {
                 recordEl.innerText = t('rec_unaffected');
                 recordEl.style.color = "#FFD700";
                 recordEl.style.animation = "none";
            }
            else if (win) {
                if (bestVal === null || state.totalTime < bestVal) {
                    localStorage.setItem(key, state.totalTime);
                    recordEl.innerText = t('rec_new');
                    recordEl.style.color = "var(--success-color)";
                    recordEl.style.animation = "pulse 1s infinite"; 
                } else {
                    recordEl.innerText = `${t('rec_best')} ${fmtTimePrecise(bestVal)}`;
                    recordEl.style.color = "#888";
                    recordEl.style.animation = "none";
                }
            } 
            else {
                if (bestVal !== null) {
                    recordEl.innerText = `${t('rec_best')} ${fmtTimePrecise(bestVal)}`;
                } else {
                    recordEl.innerText = t('rec_none');
                }
                recordEl.style.color = "#666";
                recordEl.style.animation = "none";
            }

            // === Config Display ===
            // ä½¿ç”¨ç¿»è¯‘åçš„æ–‡æœ¬
            const deckKey = 'btn_' + cfg.deck;
            const timeKey = 'btn_' + cfg.time;
            const lifeKey = 'btn_' + cfg.life;
            let roundKey = 'btn_base';
            if(cfg.rounds === 10) roundKey = 'btn_endurance';
            else if(cfg.rounds === -1) roundKey = 'btn_infinite';
            
            // å»æ‰æ‹¬å·é‡Œçš„å†…å®¹ç®€ç•¥æ˜¾ç¤º
            const clean = (k) => t(k).split(' (')[0];

            const configStr = [
                cfg.target.toString(),
                clean(deckKey),
                clean(timeKey),
                clean(lifeKey),
                clean(roundKey)
            ].join(' / ').toUpperCase();

            $('end-config').innerText = configStr;

            // === Clears ===
            const modeKeyRaw = `${cfg.deck}_${cfg.time}_${cfg.life}_${cfg.rounds}`;
            const clearKey = `${getPrefix()}_clears_${modeKeyRaw}`;
            let modeClears = parseInt(localStorage.getItem(clearKey) || '0');

            const isStandardWin = (cfg.rounds !== -1 && win);
            const isInfiniteClear = (cfg.rounds === -1 && survivalScore > 0);
            const isValidClear = (isStandardWin || isInfiniteClear) && !isMiracle && !state.hintUsed;

            if (isValidClear) {
                modeClears++;
                localStorage.setItem(clearKey, modeClears);
            }

            const clearsEl = $('end-clears');
            clearsEl.innerText = `${t('mode_clears')} ${modeClears}`;
            
            if (isValidClear) {
                clearsEl.style.color = "var(--success-color)";
                clearsEl.style.textShadow = "0 0 10px rgba(0, 255, 157, 0.3)";
            } else {
                clearsEl.style.color = "var(--secondary-color)";
                clearsEl.style.textShadow = "none";
            }

            // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œç­‰ç•Œé¢å¼¹å‡ºçš„åŠ¨ç”»ç»“æŸå†å¼€å§‹æ¼”å¥ï¼Œæ›´æœ‰ä»ªå¼æ„Ÿ
            setTimeout(() => {
                // åªæœ‰å½“å£°éŸ³å¼€å¯æ—¶æ‰æ’­æ”¾
                if (!AudioSys.muted) {
                    ResultSequencer.start(state.history);
                }
            }, 500);
        }

        function backToMenu() {
            ResultSequencer.stop();
            
            $('game-ui').style.display = 'none';
            $('game-over').style.display = 'none';
            $('start-screen').style.display = 'flex';
            state.active = false;
            clearInterval(state.interval);
        }

        function openReview() {
            ResultSequencer.stop();
            
            $('review-ui').style.display = 'flex';
            let list = $('review-list');
            let cardDisplay = $('review-display');
            let solDisplay = $('review-sol');
            let lblSol = $('lbl-sol'); 

            list.innerHTML = ''; cardDisplay.innerHTML = ''; solDisplay.innerText = ''; 
            
            if (state.history.length === 0) {
                lblSol.style.display = 'block';
                solDisplay.style.display = 'block';
                solDisplay.innerText = t('lbl_no_records');
                solDisplay.style.color = "var(--secondary-color)";
                return;
            }

            [...state.history].reverse().forEach((h, i) => {
                let d = document.createElement('div');
                d.className = 'log-entry';
                let originalIndex = state.history.length - i;

                if (h.status === 'remaining') {
                    d.innerText = `[${t('lbl_remaining')}]`; 
                    d.style.color = "var(--secondary-color)";
                    d.style.letterSpacing = "1px";
                } else {
                    if(h.status === 'fail') d.style.color = 'var(--alert-color)';
                    d.innerText = `[${originalIndex.toString()}]  ${h.cards.join(' ')}`;
                }

                d.onclick = function() {
                    Array.from(list.children).forEach(child => child.classList.remove('active'));
                    d.classList.add('active');
                    // === æ–°å¢ï¼šç‚¹å‡»å†å²è®°å½•æ’­æ”¾è¯¥æ¬¡å‡ºç‰Œçš„å’Œå¼¦ ===
                    // h.cards æ˜¯ç±»ä¼¼ [3, 8, 4] çš„æ•°å­—æ•°ç»„ï¼Œç›´æ¥ä¼ ç»™ playChord å³å¯
                    // åªæœ‰å½“è¿™æ¬¡æ“ä½œæ˜¯æˆåŠŸæˆ–è€…æœ‰å‰©ä½™ç‰Œæ—¶æ‰æ’­æ”¾ï¼Œé¿å…æ’­æ”¾ 'null'
                    if (h.status === 'success' && h.cards && h.cards.length > 0) {
                        // ä¸ºäº†é˜²æ­¢å£°éŸ³å¤ªå¤§ï¼Œå¯ä»¥ç¨å¾®é™åˆ¶ä¸€ä¸‹
                        AudioSys.playChord(h.cards);
                    }
                    
                    Array.from(list.children).forEach(child => child.classList.remove('active'));
                    d.classList.add('active');

                    if (h.cards.length > 6) {
                        cardDisplay.classList.add('mini-view');
                    } else {
                        cardDisplay.classList.remove('mini-view');
                    }
                    
                    cardDisplay.innerHTML = h.cards.map(v => 
                        `<div class="card selected" style="cursor:default">${v}</div>`
                    ).join('');
                    
                    if (h.status === 'remaining') {
                        lblSol.style.display = 'none';
                        solDisplay.style.display = 'none';
                    } else {
                        lblSol.style.display = 'block';
                        solDisplay.style.display = 'block';
                        
                        if (h.sol) {
                            solDisplay.innerText = h.sol;
                            solDisplay.style.color = "var(--primary-color)";

                            const stepHtml = StepAnalyzer.generateHTML(h.sol);
                            $('step-list').innerHTML = stepHtml;
                            $('step-container').style.display = 'block';
                            
                            // é‡ç½®æŠ˜å çŠ¶æ€
                            //$('step-list').classList.remove('open');
                            //$('btn-toggle-steps').classList.remove('open');
                        } else {
                            solDisplay.innerText = t('lbl_no_solution');
                            solDisplay.style.color = "var(--alert-color)";
                            
                            $('step-container').style.display = 'none';
                        }

                        setTimeout(() => {
                                fitText(solDisplay);
                            }, 0);
                    }
                };
                list.appendChild(d);
            });
            
            if (list.firstChild) list.firstChild.click();
        }

        // === å…³é—­å¤ç›˜å¹¶æ¢å¤èƒŒæ™¯æ¼”å¥ ===
        function closeReview() {
            // 1. éšè—å¤ç›˜çª—å£
            $('review-ui').style.display = 'none';
        
            // 2. æ£€æŸ¥æ˜¯å¦åœ¨ç»“ç®—ç•Œé¢ (Game Over)ï¼Œä¸”å£°éŸ³æœªé™éŸ³
            // åªæœ‰åœ¨æ¸¸æˆç»“æŸçŠ¶æ€ä¸‹ï¼Œæ‰éœ€è¦æ¢å¤èƒŒæ™¯å¾ªç¯
            // state.active === false æ„å‘³ç€æ¸¸æˆç»“æŸ
            if (!state.active && !AudioSys.muted) {
                // é‡æ–°å¯åŠ¨çˆµå£«å¾ªç¯
                ResultSequencer.start(state.history);
            }
        }

        /* === ä¼˜åŒ–åçš„æ™ºèƒ½æç¤ºåŠŸèƒ½ === */
        function getHint() {
            if (!state.active || !isDbReady) return;
        
            state.hintUsed = true; // æ ‡è®°ä½¿ç”¨äº†æç¤ºï¼Œä¸è®¡å…¥æˆç»©
        
            // 0. æ¸…é™¤ä¹‹å‰çš„è§†è§‰æç¤º
            $('btn-draw').classList.remove('suggest');
            $('btn-all').classList.remove('suggest');
        
            const hand = state.hand;
            
            // === é€»è¾‘ 1: æ£€æµ‹ "All In" (å…¨æŠ¼) æœºä¼š ===
            // å¦‚æœæ‰‹ç‰Œæ•°é‡åœ¨ 2-4 å¼ ä¹‹é—´ï¼Œä¸”å…¨éƒ¨åŠ èµ·æ¥æ­£å¥½æœ‰è§£
            if (hand.length >= 2 && hand.length <= 4) {
                // æ„å»ºå½“å‰å…¨æ‰‹ç‰Œçš„ key
                const allVals = hand.map(c => c.val).sort((a, b) => a - b).join(',');
                
                if (solutionDB.has(allVals)) {
                    // æ‰¾åˆ°äº†å…¨è§£ï¼
                    clearSelection(); // å–æ¶ˆå½“å‰çš„é€‰æ‹©ï¼Œè§†è§‰ä¸Šæ›´æ¸…çˆ½
                    
                    // é«˜äº®å…¨æŠ¼æŒ‰é’®
                    const btnAll = $('btn-all');
                    btnAll.classList.add('suggest');
                    
                    setStatus("msg_hint_all", "var(--primary-color)");
                    return; // ç»“æŸï¼Œä¸å†å¯»æ‰¾éƒ¨åˆ†è§£
                }
            }
        
            // === é€»è¾‘ 2: å¯»æ‰¾éƒ¨åˆ†è§£ (åŸºäºç©å®¶æ„å›¾) ===
            
            // 1. è®°å½•ç©å®¶å½“å‰å·²ç»é€‰ä¸­çš„ç‰Œ ID (ç”¨äºè®¡ç®—é‡åˆåº¦)
            const currentSelSet = new Set(state.selection);
            
            const indices = hand.map((_, i) => i);
            const trySizes = [4, 3, 2]; // ä¼˜å…ˆæ‰¾4å¼ ï¼Œå†æ‰¾3å¼ ...
        
            for (let r of trySizes) {
                // è·å–æ‰€æœ‰å¯èƒ½çš„ç»„åˆç´¢å¼•
                let combos = getCombinations(indices, r);
                
                // A. å…ˆéšæœºæ‰“ä¹±ï¼Œä¿è¯æ¯æ¬¡æç¤ºçš„è§£æ³•ä¸å›ºå®š
                shuffleArray(combos);
        
                // B. ã€æ ¸å¿ƒä¼˜åŒ–ã€‘å¦‚æœç©å®¶å·²ç»é€‰äº†ç‰Œï¼Œå¯¹ç»„åˆè¿›è¡Œé‡æ’åº
                if (currentSelSet.size > 0) {
                    combos.sort((a, b) => {
                        // è®¡ç®—ç»„åˆ a ä¸­æœ‰å¤šå°‘å¼ ç‰Œæ˜¯ç©å®¶å½“å‰é€‰ä¸­çš„
                        const overlapA = a.filter(idx => currentSelSet.has(hand[idx].id)).length;
                        // è®¡ç®—ç»„åˆ b ä¸­æœ‰å¤šå°‘å¼ ç‰Œæ˜¯ç©å®¶å½“å‰é€‰ä¸­çš„
                        const overlapB = b.filter(idx => currentSelSet.has(hand[idx].id)).length;
                        
                        // é™åºæ’åˆ—ï¼šé‡åˆåº¦é«˜çš„æ’å‰é¢
                        return overlapB - overlapA;
                    });
                }
        
                // C. éå†æ£€æŸ¥è§£æ³•
                for (let comboIndices of combos) {
                    let candidateCards = comboIndices.map(i => hand[i]);
                    let values = candidateCards.map(c => c.val).sort((a, b) => a - b);
                    let key = values.join(',');
        
                    if (solutionDB.has(key)) {
                        // æ‰¾åˆ°äº†è§£æ³•ï¼
                        
                        // å…ˆæ¸…é™¤ä¹‹å‰çš„é€‰æ‹©ï¼ˆå¯èƒ½åŒ…å«ç©å®¶é€‰é”™çš„ç‰Œï¼‰
                        clearSelection(); 
                        
                        // é€‰ä¸­ç®—æ³•æ¨èçš„ç‰Œ
                        candidateCards.forEach(c => toggleSelect(c.id));
                        return; // ç»“æŸ
                    }
                }
            }
        
            // === é€»è¾‘ 3: å®åœ¨æ— è§£ï¼Œæç¤ºæŠ½ç‰Œ ===
            if (state.hand.length < 10) {
                setStatus("msg_no_moves", "var(--primary-color)");
                $('btn-draw').classList.add('suggest');
            } else {
                setStatus("msg_deadlock", "var(--alert-color)");
            }
        }

        function getCombinations(arr, k) {
            let i, subI, ret = [], sub, next;
            for (i = 0; i < arr.length; i++) {
                if (k === 1) {
                    ret.push([arr[i]]);
                } else {
                    sub = getCombinations(arr.slice(i + 1), k - 1);
                    for (subI = 0; subI < sub.length; subI++) {
                        next = sub[subI];
                        next.unshift(arr[i]);
                        ret.push(next);
                    }
                }
            }
            return ret;
        }

        async function loadData() {
            // é‡ç½®çŠ¶æ€
            isDbReady = false; 
            solutionDB.clear();
            
            // æ˜¾ç¤ºåŠ è½½ä¸­ï¼Œå¦‚æœæœ‰ msg-display çš„è¯
            setStatus("msg_loading", "var(--primary-color)");
        
            const target = cfg.target; // è·å–å½“å‰ç›®æ ‡ (24, 36, 60)
            const fileName = `database${target}.txt`; // ä¾‹å¦‚ database24.txt
            const cacheKey = `p${target}_db_cache`;   // ä¾‹å¦‚ p24_db_cache
        
            //console.log(`Loading Data for Target: ${target}...`);
        
            const processData = (text) => {
                solutionDB.clear();
                text.split('\n').forEach(line => {
                    line = line.trim();
                    if (!line || !line.includes('=')) return; 
                    // è¿‡æ»¤æ‰æ³¨é‡Šæˆ–ç©ºè¡Œï¼Œç¡®ä¿åªå­˜ç®—å¼
                    let nums = line.replace(/[^\d]/g, ' ').trim().split(/\s+/).map(Number);
                    nums.pop(); // å»æ‰æœ€åçš„ç»“æœæ•°å­—
                    nums.sort((a, b) => a - b);
                    solutionDB.set(nums.join(','), line);
                });
            };
        
            try {
                // 1. å°è¯•ç½‘ç»œè¯·æ±‚
                const response = await fetch(`https://stellate0511.github.io/Project-24/${fileName}`);
                
                if (!response.ok) throw new Error("Network connection failed");
                
                const text = await response.text();
                processData(text);
                
                // å†™å…¥å¯¹åº”ç›®æ ‡çš„ç¼“å­˜
                try {
                    localStorage.setItem(cacheKey, text);
                } catch (e) {
                    console.warn("Cache write failed", e);
                }
        
                isDbReady = true;
                setStatus("msg_ready", "var(--secondary-color)");
        
            } catch (err) {
                console.warn(`Network load failed for ${target}, attempting fallback...`, err);
                
                // 2. å°è¯•è¯»å–å¯¹åº”ç›®æ ‡çš„æœ¬åœ°ç¼“å­˜
                const cachedText = localStorage.getItem(cacheKey);
                
                if (cachedText) {
                    processData(cachedText);
                    isDbReady = true;
                    setStatus("msg_ready", "var(--secondary-color)");
                } else {
                    console.error("Critical: No network and no cache.");
                    setStatus("msg_db_fail", "var(--alert-color)");
                    // åªæœ‰åœ¨é 24 (é»˜è®¤) çš„æƒ…å†µä¸‹æ‰æç¤ºä¸¥é‡é”™è¯¯ï¼Œé¿å…é¦–æ¬¡åŠ è½½å“åˆ°ç”¨æˆ·
                    alert(`æ— æ³•åŠ è½½ ${target} ç‚¹çš„è§£æ³•æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼`);
                }
            }
        }

        function updateAppIdentity() {
            const tVal = cfg.target;
            
            // 1. æ›´æ–°ç½‘é¡µæ ‡é¢˜å’Œ H1
            const titleStr = `PROJECT: ${tVal}`;
            document.title = titleStr;
            document.querySelector('h1').innerText = titleStr;
        
            // 2. æ›´æ–°æ‰€æœ‰å¸¦æœ‰ .dyn-target ç±»çš„æ•°å­— (è§„åˆ™æ–‡æœ¬)
            document.querySelectorAll('.dyn-target').forEach(el => {
                el.innerText = tVal;
            });
        }

        // ä¿®æ”¹ loadLastConfigï¼Œç¡®ä¿åŠ è½½ä¸Šæ¬¡é…ç½®æ—¶ä¹Ÿåˆ·æ–°UI
        function loadLastConfig() {
            const saved = localStorage.getItem('p24_last_config');
            if (!saved) {
                // å¦‚æœæ²¡æœ‰å­˜æ¡£ï¼Œé»˜è®¤åŠ è½½ä¸€æ¬¡æ•°æ®
                loadData();
                return; 
            }
        
            try {
                const parsed = JSON.parse(saved);
                // ç¡®ä¿ target å­˜åœ¨ (å…¼å®¹æ—§å­˜æ¡£)
                if(!parsed.target) parsed.target = 24; 
                
                Object.assign(cfg, parsed);
        
                const setUI = (groupId, val) => {
                    const group = $(groupId);
                    if (!group) return;
                    group.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    const target = group.querySelector(`button[data-val="${val}"]`);
                    if (target) target.classList.add('active');
                };
        
                setUI('opt-target', cfg.target); // è®¾ç½®ç›®æ ‡æŒ‰é’®çŠ¶æ€
                setUI('opt-deck', cfg.deck);
                setUI('opt-time', cfg.time);
                setUI('opt-life', cfg.life);
                setUI('opt-rounds', cfg.rounds);
                
                // åŠ è½½é…ç½®åï¼Œå¿…é¡»åˆ·æ–°èº«ä»½å’Œæ•°æ®
                updateAppIdentity();
                loadData();
        
            } catch (e) {
                console.error("Config load error", e);
                loadData(); // å‡ºé”™ä¿åº•åŠ è½½
            }
        }
        loadLastConfig();

        document.addEventListener('keydown', (e) => {
            if (!state.active || $('game-over').style.display === 'flex' || $('review-ui').style.display === 'flex') return;

            const key = e.key.toLowerCase();

            if (/\d/.test(key)) {
                let num = parseInt(key);
                let targetIndex = (num === 0) ? 9 : num - 1;
                
                if (state.hand[targetIndex]) {
                    toggleSelect(state.hand[targetIndex].id);
                    const cardEl = document.querySelectorAll('.card')[targetIndex];
                    if(cardEl) {
                        cardEl.style.transform = "scale(0.95)";
                        setTimeout(() => cardEl.style.transform = "", 100);
                    }
                }
                return;
            }

            switch(key) {
                case 'q': 
                    if (!$('btn-draw').disabled) {
                        drawCards(1);
                        simulateClick('btn-draw');
                    }
                    break;
                    
                case 'escape': 
                    if (state.selection.length > 0) {
                        clearSelection();
                        simulateClick('btn-clear');
                    }
                    break;
                    
                case 'enter': 
                    if (!$('btn-exec').disabled) {
                        execCards();
                        simulateClick('btn-exec');
                    } 
                    else if ($('btn-all').style.display === 'block') {
                        selectAllAndExec();
                        simulateClick('btn-all');
                    }
                    break;
            }
        });

        function simulateClick(btnId) {
            const btn = $(btnId);
            if(btn) {
                btn.classList.add('active');
                setTimeout(() => btn.classList.remove('active'), 150);
            }
        }
        
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (btn) {
                btn.blur(); 
            }
        }, true);

        // === ä¸»é¢˜ä¸è¯­è¨€æ§åˆ¶ ===
        
        function initTheme() {
            const savedTheme = localStorage.getItem('p24_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            // åˆå§‹åŒ–è¯­è¨€ (ä¼šåŒæ—¶åˆ·æ–°ä¸»é¢˜æŒ‰é’®æ–‡å­—)
            setLang(state.lang);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('p24_theme', next);
            updateThemeBtnText();
        }

        function updateThemeBtnText() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const btnMain = document.getElementById('theme-btn-main');
            
            // æŒ‰é’®æ˜¾ç¤ºçš„æ˜¯"å½“å‰ä¸»é¢˜çš„åå­—"
            // æš—è‰²æ¨¡å¼æ˜¾ç¤º "ç‚¹ç¼€" (æˆ– Cyber)
            // äº®è‰²æ¨¡å¼æ˜¾ç¤º "æ˜Ÿç©º" (æˆ– Cute)
            const key = currentTheme === 'dark' ? 'theme_dark' : 'theme_light';
            if(btnMain) btnMain.innerText = t(key);
        }

        initTheme();

        function toggleRules() {
            const ui = document.getElementById('rules-ui');
            
            // 1. å¦‚æœå½“å‰æ˜¯å¼€ç€çš„ï¼Œå°±å…³æ‰
            if (ui.style.display === 'flex') {
                ui.style.display = 'none';
                return;
            }

            // 2. å¦‚æœæ˜¯å…³ç€çš„ï¼Œå‡†å¤‡æ‰“å¼€
            ui.style.display = 'flex';

            // 3. æ ¸å¿ƒé€»è¾‘ï¼šæ ¹æ®å½“å‰è¯­è¨€ state.lang å†³å®šæ˜¾ç¤ºå“ªä¸ªå—
            const zhBlock = document.getElementById('rules-zh');
            const enBlock = document.getElementById('rules-en');

            if (state.lang === 'zh') {
                zhBlock.style.display = 'block';
                enBlock.style.display = 'none';
                zhBlock.scrollTop = 0; // é‡ç½®æ»šåŠ¨æ¡
            } else {
                zhBlock.style.display = 'none';
                enBlock.style.display = 'block';
                enBlock.scrollTop = 0; // é‡ç½®æ»šåŠ¨æ¡
            }
        }
        
        function updateSoundBtn() {
            const btn = $('sound-btn');
            if(!btn) return;
            
            const isMuted = AudioSys.muted;
            
            btn.innerHTML = isMuted ? iconSoundOff : iconSoundOn;
            btn.style.opacity = isMuted ? '0.5' : '1';
        }
        
        function toggleSound() {
            AudioSys.toggleMute();
            updateSoundBtn();
        }
        
        // === é‡è¦ï¼šåˆå§‹åŒ– ===
        // åœ¨é¡µé¢åŠ è½½å®Œæˆæˆ–è„šæœ¬æœ€åè°ƒç”¨ä¸€æ¬¡ï¼Œç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡®
        updateSoundBtn();

        // === å…¨å±€æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆå¤„ç† ===
        document.addEventListener('click', (e) => {
            // å‘ä¸ŠæŸ¥æ‰¾æ˜¯å¦ç‚¹å‡»äº†æŒ‰é’®
            const btn = e.target.closest('button');
            if (!btn) return;
        
            // æ’é™¤åˆ—è¡¨ï¼šè¿™äº›æŒ‰é’®å·²ç»æœ‰ä¸“é—¨çš„éŸ³æ•ˆäº†ï¼Œä¸éœ€è¦æ’­æ”¾åŸºç¡€ Click éŸ³
            // 1. é¦–é¡µçš„é…ç½®é€‰é¡¹æŒ‰é’® (åœ¨ .btn-group å†…)
            if (btn.closest('.btn-group')) return;
        
            // 2. å³ä¸Šè§’çš„å£°éŸ³å¼€å…³ (sound-btn) - é¿å…å¼€å…³é™éŸ³æ—¶å¬åˆ°å£°éŸ³
            if (btn.id === 'sound-btn') return;
            if (btn.id === 'btn-exec') return;
        
            // === æ’­æ”¾åŸºç¡€æœºæ¢°éŸ³ ===
            AudioSys.playClick();
        });

        // === è‡ªåŠ¨ç¼©æ”¾æ–‡æœ¬ä»¥é€‚åº”å®¹å™¨ ===
        function fitText(element) {
            if (!element) return;
        
            // 1. å…ˆé‡ç½®ç¼©æ”¾ï¼Œæ‰èƒ½è·å–çœŸå®çš„ scrollWidth
            element.style.transform = 'scale(1)';
            
            // 2. è·å–çˆ¶å®¹å™¨çš„å¯ç”¨å®½åº¦ (å‡å»ä¸€ç‚¹ padding ç¼“å†²)
            // è¿™é‡Œå‡è®¾çˆ¶å®¹å™¨æ˜¯ #review-detailï¼Œæˆ‘ä»¬ç”¨ element è‡ªå·±çš„å®½åº¦é™åˆ¶æ¥ç®—æ›´ç®€å•
            // ç›´æ¥æ¯”è¾ƒ å…ƒç´ å†…å®¹çš„çœŸå®å®½åº¦(scrollWidth) å’Œ å…ƒç´ è®¾å®šçš„æ˜¾ç¤ºå®½åº¦(offsetWidth)
            
            // ä¸ºäº†ä¿é™©ï¼Œæˆ‘ä»¬ç”¨çˆ¶å…ƒç´ çš„å®½åº¦ä½œä¸ºåŸºå‡†
            const parentWidth = element.parentElement.offsetWidth * 0.9; // ç•™ 10% è¾¹è·
            const contentWidth = element.scrollWidth;
        
            // 3. å¦‚æœå†…å®¹æ¯”å®¹å™¨å®½ï¼Œè®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            if (contentWidth > parentWidth) {
                const scale = parentWidth / contentWidth;
                element.style.transform = `scale(${scale})`;
            } else {
                element.style.transform = 'scale(1)';
            }
        }

        // === æ­¥éª¤è§£æä¸ç”Ÿæˆå™¨ (ä¿®æ­£ç‰ˆ) ===
        const StepAnalyzer = {
            // é¢œè‰²ç±»åæ˜ å°„
            typeClass: {
                'card': 'num-c1',  // åŸå¡ç‰Œ (ç™½è‰²)
                'step1': 'num-c2', // ç¬¬ä¸€æ­¥ç»“æœ (æ·¡è“)
                'step2': 'num-c3', // ç¬¬äºŒæ­¥ç»“æœ (æ·¡ç´«)
                'final': 'num-c4'  // æœ€ç»ˆç»“æœ (é‡‘è‰²)
            },
        
            // å…¥å£å‡½æ•°
            generateHTML(solutionStr) {
                if (!solutionStr) return '';
        
                // === ä¿®å¤ç‚¹ 1ï¼šåªå–ç­‰å·å·¦è¾¹çš„éƒ¨åˆ† ===
                // å¦‚æœå­—ç¬¦ä¸²æ˜¯ "3 * 8 = 24"ï¼Œè¿™å°±åªå– "3 * 8"
                // è¿™æ ·æœ€åçš„ç›®æ ‡æ•°å­—å°±ä¸ä¼šå¹²æ‰°è§£æå™¨äº†
                let expressionPart = solutionStr.split('=')[0];
        
                // é¢„å¤„ç†ï¼šæ›¿æ¢ç¬¦å·ï¼Œå»é™¤ç©ºæ ¼
                const cleanStr = expressionPart.replace(/Ã—/g, '*').replace(/Ã·/g, '/').replace(/\s+/g, '');
                
                try {
                    const rpnQueue = this.toRPN(cleanStr);
                    const steps = this.solveRPN(rpnQueue);
                    return steps.map(step => this.renderStepRow(step)).join('');
                } catch (e) {
                    console.warn("Step analysis failed:", e);
                    return '<div style="font-size:0.7rem; color:#666">æ­¥éª¤è§£æå¤±è´¥</div>';
                }
            },
        
            // ... toRPN å‡½æ•°ä¿æŒä¸å˜ ...
            toRPN(str) {
                const outputQueue = [];
                const opStack = [];
                const operators = { '+': 1, '-': 1, '*': 2, '/': 2 };
                
                const tokens = str.match(/(\d+(\.\d+)?)|[+\-*/()]/g);
                if (!tokens) return []; // å®¹é”™
        
                tokens.forEach(token => {
                    if (!isNaN(parseFloat(token))) {
                        // æ‰€æœ‰ä»å­—ç¬¦ä¸²é‡Œè§£æå‡ºæ¥çš„æ•°å­—ï¼Œæœ€åˆéƒ½è§†ä¸º "åŸå¡ç‰Œ"
                        outputQueue.push({ val: parseFloat(token), type: 'card' }); 
                    } else if ('+-*/'.includes(token)) {
                        while (
                            opStack.length &&
                            opStack[opStack.length - 1] !== '(' &&
                            operators[opStack[opStack.length - 1]] >= operators[token]
                        ) {
                            outputQueue.push(opStack.pop());
                        }
                        opStack.push(token);
                    } else if (token === '(') {
                        opStack.push(token);
                    } else if (token === ')') {
                        while (opStack.length && opStack[opStack.length - 1] !== '(') {
                            outputQueue.push(opStack.pop());
                        }
                        opStack.pop(); 
                    }
                });
                
                while (opStack.length) outputQueue.push(opStack.pop());
                return outputQueue;
            },
        
            // === ä¿®æ”¹åçš„ solveRPN æ–¹æ³• ===
            solveRPN(queue) {
                const stack = [];
                const steps = [];
                let opCount = 0; 
        
                queue.forEach(item => {
                    if (typeof item === 'object') {
                        stack.push(item);
                    } else {
                        const b = stack.pop();
                        const a = stack.pop();
                        
                        if (!a || !b) return;
        
                        opCount++;
        
                        let resVal = 0;
                        let symbol = '';
                        
                        switch(item) {
                            case '+': resVal = a.val + b.val; symbol = '+'; break;
                            case '-': resVal = a.val - b.val; symbol = '-'; break;
                            case '*': resVal = a.val * b.val; symbol = 'Ã—'; break;
                            case '/': resVal = a.val / b.val; symbol = 'Ã·'; break;
                        }
        
                        if (!Number.isInteger(resVal)) {
                            resVal = parseFloat(resVal.toFixed(2));
                        }
        
                        // === é€»è¾‘å˜æ›´ ===
                        // 1. ä¸­é—´è¿‡ç¨‹é»˜è®¤é¢œè‰²é€»è¾‘ï¼š
                        //    ç¬¬1æ­¥äº§ç”Ÿçš„ä¸­é—´æ•° -> step1 (é¢œè‰²2/è“)
                        //    ç¬¬2æ­¥åŠä»¥åäº§ç”Ÿçš„ä¸­é—´æ•° -> step2 (é¢œè‰²3/ç´«)
                        //    (æ³¨æ„ï¼šæˆ‘ä»¬æš‚æ—¶ä¸åœ¨è¿™é‡Œå†³å®š finalï¼Œæœ€åç»Ÿä¸€å¤„ç†)
                        let resType = (opCount >= 2) ? 'step2' : 'step1';
        
                        // 2. æ„é€ æ­¥éª¤å¯¹è±¡
                        // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ res å¯¹è±¡å­˜å…¥ steps
                        const stepObj = {
                            a: a,
                            b: b,
                            op: symbol,
                            res: { val: resVal, type: resType }
                        };
        
                        steps.push(stepObj);
        
                        // 3. ç»“æœå…¥æ ˆä¾›ä¸‹ä¸€æ­¥ä½¿ç”¨
                        stack.push({ val: resVal, type: resType });
                    }
                });
        
                // === å…³é”®ä¿®æ”¹ï¼šå¼ºåˆ¶æœ€åä¸€æ­¥ä¸º Final é¢œè‰² ===
                // æ— è®ºæ€»å…±æœ‰å‡ æ­¥ï¼Œæœ€åä¸€æ­¥çš„ç»“æœä¸€å®šæ˜¯æœ€ç»ˆç­”æ¡ˆï¼Œèµ‹äºˆ num-c4 (é‡‘è‰²)
                if (steps.length > 0) {
                    steps[steps.length - 1].res.type = 'final';
                }
        
                return steps;
            },
        
            renderStepRow(step) {
                const fmt = (obj) => `<span class="${this.typeClass[obj.type]}">${obj.val}</span>`;
                return `
                    <div class="step-row">
                        ${fmt(step.a)}
                        <span class="op-symbol">${step.op}</span>
                        ${fmt(step.b)}
                        <span class="op-symbol">=</span>
                        ${fmt(step.res)}
                    </div>
                `;
            }
        };

        function toggleSteps() {
            const list = $('step-list');
            const btn = $('btn-toggle-steps');
            if (list.classList.contains('open')) {
                list.classList.remove('open');
                btn.classList.remove('open');
            } else {
                list.classList.add('open');
                btn.classList.add('open');
            }
            // æ’­æ”¾æ™®é€šç‚¹å‡»éŸ³æ•ˆ
            AudioSys.playClick();
        }
    </script>
</body>
</html>
